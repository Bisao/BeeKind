<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>Bee World - RPG Edition</title>
Â  Â  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
Â  Â  <style>
Â  Â  Â  Â  :root { --primary: #f1c40f; --bg-dark: rgba(20, 20, 20, 0.85); --text-main: #ffffff; --xp-color: #3498db; --border: rgba(255, 255, 255, 0.1); }
Â  Â  Â  Â  body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; color: var(--text-main); touch-action: none; user-select: none; }
Â  Â  Â  Â  canvas { display: none; image-rendering: pixelated; }

Â  Â  Â  Â  /* HUD CENTRAL */
Â  Â  Â  Â  #central-hud {
Â  Â  Â  Â  Â  Â  position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; align-items: center; gap: 8px;
Â  Â  Â  Â  Â  Â  z-index: 100; pointer-events: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  #lvl-hud {
Â  Â  Â  Â  Â  Â  background: var(--bg-dark); padding: 10px 25px; border-radius: 25px;
Â  Â  Â  Â  Â  Â  text-align: center; min-width: 220px; backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border); display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â  #xp-bar-container { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-top: 6px; overflow: hidden; }
Â  Â  Â  Â  #xp-bar-fill { width: 0%; height: 100%; background: var(--xp-color); transition: width 0.3s; box-shadow: 0 0 8px var(--xp-color); }
Â  Â  Â  Â  #lvl-text { font-weight: bold; color: var(--primary); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
Â  Â  Â  Â  #coords {Â 
Â  Â  Â  Â  Â  Â  font-family: monospace; color: var(--primary); background: var(--bg-dark);Â 
Â  Â  Â  Â  Â  Â  padding: 4px 15px; border-radius: 12px; font-size: 12px;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border); backdrop-filter: blur(5px);
Â  Â  Â  Â  Â  Â  opacity: 0.9; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* PAINEL DE SESSÃƒO */
Â  Â  Â  Â  #session-panel {
Â  Â  Â  Â  Â  Â  position: absolute; top: 100px; left: -210px; width: 200px; z-index: 101;Â 
Â  Â  Â  Â  Â  Â  transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  Â  Â  }
Â  Â  Â  Â  #session-panel.active { left: 15px; }
Â  Â  Â  Â  #player-list {Â 
Â  Â  Â  Â  Â  Â  background: var(--bg-dark); padding: 15px; border-radius: 12px;Â 
Â  Â  Â  Â  Â  Â  border-left: 4px solid var(--primary); font-size: 13px;Â 
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px); border: 1px solid var(--border);
Â  Â  Â  Â  Â  Â  box-shadow: 5px 5px 15px rgba(0,0,0,0.4);
Â  Â  Â  Â  }
Â  Â  Â  Â  #btn-session-toggle {
Â  Â  Â  Â  Â  Â  position: absolute; right: -40px; top: 0;
Â  Â  Â  Â  Â  Â  width: 35px; height: 35px; background: var(--primary);
Â  Â  Â  Â  Â  Â  border: none; border-radius: 0 8px 8px 0; cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 18px; display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  box-shadow: 2px 0 10px rgba(0,0,0,0.2); color: #111;
Â  Â  Â  Â  }

Â  Â  Â  Â  .player-item { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }

Â  Â  Â  Â  /* HUD PÃ“LEN */
Â  Â  Â  Â  #pollen-hud {Â 
Â  Â  Â  Â  Â  Â  position: absolute; top: 50%; right: 20px; transform: translateY(-50%);
Â  Â  Â  Â  Â  Â  background: var(--bg-dark); padding: 15px; border-radius: 15px;
Â  Â  Â  Â  Â  Â  border-right: 5px solid #fffa65; display: none; text-align: center;
Â  Â  Â  Â  Â  Â  min-width: 80px; backdrop-filter: blur(10px); z-index: 100; border: 1px solid var(--border);
Â  Â  Â  Â  }
Â  Â  Â  Â  #pollen-val { font-size: 24px; font-weight: bold; color: #fffa65; }

Â  Â  Â  Â  /* MODAIS */
Â  Â  Â  Â  #death-modal, #game-over-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
Â  Â  Â  Â  .modal-title { color: #e74c3c; font-size: 48px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; text-align: center; }

Â  Â  Â  Â  /* CHAT */
Â  Â  Â  Â  #chat-wrapper {Â 
Â  Â  Â  Â  Â  Â  position: absolute; bottom: 160px; left: -240px; width: 240px; z-index: 500;Â 
Â  Â  Â  Â  Â  Â  display: none; flex-direction: column; transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #chat-display { height: 160px; background: var(--bg-dark); border-radius: 0 12px 0 0; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; border: 1px solid var(--border); backdrop-filter: blur(15px); font-size: 13px; }
Â  Â  Â  Â  #chat-input-area { display: flex; background: rgba(30, 30, 30, 0.95); padding: 8px; border-radius: 0 0 12px 0; border: 1px solid var(--border); }
Â  Â  Â  Â  #chat-input { flex: 1; background: transparent; border: none; color: white; padding: 4px; font-size: 14px; outline: none; }
Â  Â  Â  Â  #btn-minimize-chat { position: absolute; right: -45px; bottom: 0; background: var(--primary); color: #111; border: none; border-radius: 0 8px 8px 0; cursor: pointer; width: 45px; height: 45px; font-size: 20px; font-weight: bold; box-shadow: 4px 0 10px rgba(0,0,0,0.3); }

Â  Â  Â  Â  /* MENU INICIAL */
Â  Â  Â  Â  #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: #222; padding: 40px; border-radius: 20px; border: 2px solid var(--primary); z-index: 3000; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
Â  Â  Â  Â  .main-btn { padding: 12px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; background: var(--primary); font-size: 16px; width: 100%; margin-top: 10px; color: #111; }

Â  Â  Â  Â  /* JOYSTICKS */
Â  Â  Â  Â  .joy-container { position: absolute; bottom: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; border: 2px solid rgba(255,255,255,0.2); z-index: 150; }
Â  Â  Â  Â  #move-base { left: 40px; }
Â  Â  Â  Â  #aim-base { right: 40px; border-color: rgba(255, 71, 87, 0.3); }
Â  Â  Â  Â  .joy-stick { position: absolute; width: 50px; height: 50px; border-radius: 50%; top: 35px; left: 35px; pointer-events: none; opacity: 0.8; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
Â  Â  </style>
</head>
<body>

Â  Â  <div id="central-hud">
Â  Â  Â  Â  <div id="lvl-hud">
Â  Â  Â  Â  Â  Â  <div id="lvl-text">NÃ­vel 1</div>
Â  Â  Â  Â  Â  Â  <div id="xp-bar-container"><div id="xp-bar-fill"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="coords">X: 1100 Y: 1100</div>
Â  Â  </div>

Â  Â  <div id="session-panel">
Â  Â  Â  Â  <button id="btn-session-toggle">ğŸ‘¥</button>
Â  Â  Â  Â  <div id="player-list">
Â  Â  Â  Â  Â  Â  <div style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid var(--primary); padding-bottom: 5px; color: var(--primary); font-size: 11px; letter-spacing: 1px;">SESSÃƒO ATIVA</div>
Â  Â  Â  Â  Â  Â  <div id="player-items-container"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="pollen-hud"><b>CARGA PÃ“LEN</b><div id="pollen-val">0%</div></div>
Â  Â  <div id="death-modal"><h2 class="modal-title">Derrotado</h2><button class="main-btn" onclick="respawnPlayer()" style="width: 200px;">RESPAWN</button></div>
Â  Â  <div id="game-over-modal"><h2 class="modal-title">COLMEIA DESTRUÃDA</h2><button class="main-btn" onclick="location.reload()" style="width: 200px;">RECOMEÃ‡AR</button></div>
Â  Â Â 
Â  Â  <div id="chat-wrapper">
Â  Â  Â  Â  <button id="btn-minimize-chat">ğŸ’¬</button>
Â  Â  Â  Â  <div id="chat-display"></div>
Â  Â  Â  Â  <div id="chat-input-area"><input type="text" id="chat-input" placeholder="Falar..." autocomplete="off"></div>
Â  Â  </div>

Â  Â  <div id="menu">
Â  Â  Â  Â  <h1 style="color:var(--primary); margin:0 0 20px 0; letter-spacing: 3px;">BEE WORLD</h1>
Â  Â  Â  Â  <input type="text" id="player-nick" placeholder="NICKNAME" maxlength="12">
Â  Â  Â  Â  <br><input type="text" id="room-code" placeholder="CÃ“DIGO SALA" maxlength="6">
Â  Â  Â  Â  <br><button class="main-btn" onclick="startSession(true)">CRIAR SALA</button>
Â  Â  Â  Â  <button class="main-btn" style="background:#3498db; color:white;" onclick="startSession(false)">ENTRAR EM SALA</button>
Â  Â  </div>

Â  Â  <div id="move-base" class="joy-container"><div id="move-stick" class="joy-stick" style="background:var(--primary)"></div></div>
Â  Â  <div id="aim-base" class="joy-container"><div id="aim-stick" class="joy-stick" style="background:#ff4757"></div></div>
Â  Â Â 
Â  Â  <canvas id="gameCanvas"></canvas>

Â  Â  <script>
Â  Â  Â  Â  const canvas = document.getElementById('gameCanvas');
Â  Â  Â  Â  const ctx = canvas.getContext('2d', { alpha: false });
Â  Â  Â  Â  const chatInput = document.getElementById('chat-input');
Â  Â  Â  Â  const chatWrapper = document.getElementById('chat-wrapper');
Â  Â  Â  Â  const sessionPanel = document.getElementById('session-panel');
Â  Â  Â  Â  const deathModal = document.getElementById('death-modal');
Â  Â  Â  Â  const gameOverModal = document.getElementById('game-over-modal');
Â  Â  Â  Â  const pollenHud = document.getElementById('pollen-hud');
Â  Â  Â  Â  const pollenVal = document.getElementById('pollen-val');
Â  Â  Â  Â  const moveBase = document.getElementById('move-base');
Â  Â  Â  Â  const aimBase = document.getElementById('aim-base');
Â  Â  Â  Â  const moveStick = document.getElementById('move-stick');
Â  Â  Â  Â  const aimStick = document.getElementById('aim-stick');
Â  Â  Â  Â  const playerItemsContainer = document.getElementById('player-items-container');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const assets = { bee: { Down: new Image(), Left: new Image(), Up: new Image(), Right: new Image() }, ground: new Image() };
Â  Â  Â  Â  assets.bee.Down.src = 'BeeDown.png'; assets.bee.Left.src = 'BeeLeft.png'; assets.bee.Up.src = 'BeeUp.png'; assets.bee.Right.src = 'BeeRight.png';
Â  Â  Â  Â  assets.ground.src = 'Grass.png';

Â  Â  Â  Â  let isHost = false;
Â  Â  Â  Â  let hive = { x: 1000, y: 1000, hp: 500, maxHp: 500, destroyed: false };
Â  Â  Â  Â  let players = {Â 
Â  Â  Â  Â  Â  Â  me: { x: 1100, y: 1100, dir: 'Down', nick: "", color: "#f1c40f", hp: 100, isDead: false, pollen: 0, lvl: 1, xp: 0, nextXp: 100 },Â 
Â  Â  Â  Â  Â  Â  peer: { x: 1100, y: 1100, tX: 1100, tY: 1100, dir: 'Down', nick: "Amigo", color: "#3498db", active: false, hp: 100, isDead: false, pollen: 0, lvl: 1 }Â 
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  let projectiles = [], enemies = [], flowers = [], particles = [];Â 
Â  Â  Â  Â  let camera = { x: 0, y: 0 }, peer, conn, keys = {};
Â  Â  Â  Â  const TILE_SIZE = 64;
Â  Â  Â  Â  let lastNetUpdate = 0, lastShootTime = 0, lastEnemySpawnTime = 0;
Â  Â  Â  Â  let mousePos = { x: 0, y: 0 }, isMouseDown = false;
Â  Â  Â  Â  let touchIds = { move: null, aim: null }, joyMove = { dx: 0, dy: 0 }, joyAim = { angle: 0, active: false };
Â  Â  Â  Â  let waveTimer = 180, isWaveActive = false, enemiesSpawnedInWave = 0;

Â  Â  Â  Â  // Toggle Chat
Â  Â  Â  Â  document.getElementById('btn-minimize-chat').onclick = () => {
Â  Â  Â  Â  Â  Â  let isHidden = chatWrapper.style.left === "-240px" || chatWrapper.style.left === "";
Â  Â  Â  Â  Â  Â  chatWrapper.style.left = isHidden ? "0px" : "-240px";
Â  Â  Â  Â  Â  Â  document.getElementById('btn-minimize-chat').innerHTML = isHidden ? "Â«" : "ğŸ’¬";
Â  Â  Â  Â  };

Â  Â  Â  Â  // Toggle Session
Â  Â  Â  Â  document.getElementById('btn-session-toggle').onclick = () => {
Â  Â  Â  Â  Â  Â  sessionPanel.classList.toggle('active');
Â  Â  Â  Â  Â  Â  document.getElementById('btn-session-toggle').innerHTML = sessionPanel.classList.contains('active') ? "Â«" : "ğŸ‘¥";
Â  Â  Â  Â  };

Â  Â  Â  Â  function addXp(amount) {
Â  Â  Â  Â  Â  Â  if(players.me.isDead) return;
Â  Â  Â  Â  Â  Â  players.me.xp += amount;
Â  Â  Â  Â  Â  Â  if(players.me.xp >= players.me.nextXp) {
Â  Â  Â  Â  Â  Â  Â  Â  players.me.xp -= players.me.nextXp;
Â  Â  Â  Â  Â  Â  Â  Â  players.me.lvl++;
Â  Â  Â  Â  Â  Â  Â  Â  players.me.nextXp = players.me.lvl * 100;
Â  Â  Â  Â  Â  Â  Â  Â  addMsg("SISTEMA", `LEVEL UP! NÃ­vel ${players.me.lvl}!`, "msg-sys");
Â  Â  Â  Â  Â  Â  Â  Â  createParticles(players.me.x, players.me.y, "#f1c40f", 20, 'pixel');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateXpHud();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateXpHud() {
Â  Â  Â  Â  Â  Â  const perc = (players.me.xp / players.me.nextXp) * 100;
Â  Â  Â  Â  Â  Â  document.getElementById('xp-bar-fill').style.width = perc + "%";
Â  Â  Â  Â  Â  Â  document.getElementById('lvl-text').innerText = `NÃ­vel ${players.me.lvl}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function createParticles(x, y, color, count, type = 'pixel') {
Â  Â  Â  Â  Â  Â  for(let i=0; i<count; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  let vx = (Math.random() - 0.5) * 4;
Â  Â  Â  Â  Â  Â  Â  Â  let vy = (Math.random() - 0.5) * 4;
Â  Â  Â  Â  Â  Â  Â  Â  let life = 1.0;
Â  Â  Â  Â  Â  Â  Â  Â  let decay = Math.random() * 0.02 + 0.01;
Â  Â  Â  Â  Â  Â  Â  Â  if(type === 'pollen') { vx *= 0.2; vy *= 0.2; decay = 0.005; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (type === 'heart') { vx *= 0.5; vy = -Math.random(); decay = 0.01; }
Â  Â  Â  Â  Â  Â  Â  Â  particles.push({ x, y, vx, vy, life, decay, color, type });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function generateFlowers() {
Â  Â  Â  Â  Â  Â  const types = ["ğŸŒ¸", "ğŸŒ»", "ğŸŒ·"];
Â  Â  Â  Â  Â  Â  for(let i=0; i<25; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  flowers.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: Math.random() * 4000 - 1000, y: Math.random() * 4000 - 1000,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  emoji: types[Math.floor(Math.random() * types.length)],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cooldown: 0, maxCooldown: 300, phase: Math.random() * Math.PI * 2
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  generateFlowers();

Â  Â  Â  Â  window.addEventListener('mousemove', e => { mousePos.x = e.clientX; mousePos.y = e.clientY; });
Â  Â  Â  Â  window.addEventListener('mousedown', () => isMouseDown = true);
Â  Â  Â  Â  window.addEventListener('mouseup', () => isMouseDown = false);
Â  Â  Â  Â  window.addEventListener('keydown', e => {
Â  Â  Â  Â  Â  Â  if(document.activeElement === chatInput) { if(e.key === 'Enter') sendMsg(); return; }
Â  Â  Â  Â  Â  Â  if(e.key === 'Enter') { e.preventDefault(); chatInput.focus(); }
Â  Â  Â  Â  Â  Â  keys[e.code] = true;
Â  Â  Â  Â  });
Â  Â  Â  Â  window.addEventListener('keyup', e => keys[e.code] = false);

Â  Â  Â  Â  function startSession(host) {
Â  Â  Â  Â  Â  Â  const code = document.getElementById('room-code').value.trim();
Â  Â  Â  Â  Â  Â  const nick = document.getElementById('player-nick').value.trim();
Â  Â  Â  Â  Â  Â  if(!nick || !code) return alert("Preencha tudo!");
Â  Â  Â  Â  Â  Â  isHost = host;
Â  Â  Â  Â  Â  Â  players.me.nick = nick;
Â  Â  Â  Â  Â  Â  players.me.color = host ? "#f1c40f" : "#3498db";
Â  Â  Â  Â  Â  Â  players.peer.color = host ? "#3498db" : "#f1c40f";
Â  Â  Â  Â  Â  Â  peer = host ? new Peer('bee-' + code) : new Peer();
Â  Â  Â  Â  Â  Â  peer.on('open', () => { if(host) startGame(); else { conn = peer.connect('bee-' + code); setupConn(); } });
Â  Â  Â  Â  Â  Â  peer.on('connection', c => { conn = c; setupConn(); });
Â  Â  Â  Â  }

Â  Â  Â  Â  function setupConn() {
Â  Â  Â  Â  Â  Â  conn.on('open', () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  players.peer.active = true; startGame();Â 
Â  Â  Â  Â  Â  Â  Â  Â  conn.send({ type: 'handshake', nick: players.me.nick, color: players.me.color });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  conn.on('data', data => {
Â  Â  Â  Â  Â  Â  Â  Â  if(data.type === 'chat') addMsg(players.peer.nick, data.msg, "peer");
Â  Â  Â  Â  Â  Â  Â  Â  else if(data.type === 'shoot') spawnProjectile(data.x, data.y, data.angle, false);
Â  Â  Â  Â  Â  Â  Â  Â  else if(data.type === 'handshake') { players.peer.nick = data.nick; players.peer.color = data.color; }
Â  Â  Â  Â  Â  Â  Â  Â  else if(data.type === 'hit') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(data.target === 'me') takeDamage(10);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(data.target === 'hive') { hive.hp -= 5; createParticles(hive.x, hive.y, "#ff0000", 8); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(data.target === 'enemy') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let en = enemies.find(e => e.id === data.enId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(en) { en.hp -= 25; if(en.hp <= 0) createParticles(en.x, en.y, "#000", 10); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  else if(data.type === 'sync_world') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enemies = data.enemies;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isWaveActive = data.isWaveActive;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hive.hp = data.hiveHp;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(data.event === 'hive_hit') createParticles(hive.x, hive.y, "#ff0000", 5);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  else if(data.type === 'repair') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hive.hp = data.hp;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createParticles(hive.x, hive.y, "#ff4d4d", 15, 'heart');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  else if(data.type === 'pos') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players.peer.tX = data.x; players.peer.tY = data.y;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players.peer.dir = data.dir; players.peer.nick = data.nick;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players.peer.hp = data.hp; players.peer.isDead = data.isDead;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players.peer.pollen = data.pollen; players.peer.lvl = data.lvl;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players.peer.active = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function takeDamage(amount) {
Â  Â  Â  Â  Â  Â  if(players.me.isDead) return;
Â  Â  Â  Â  Â  Â  players.me.hp -= amount;
Â  Â  Â  Â  Â  Â  createParticles(players.me.x, players.me.y, "#ff0000", 5);
Â  Â  Â  Â  Â  Â  if(players.me.hp <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  players.me.hp = 0; players.me.isDead = true;
Â  Â  Â  Â  Â  Â  Â  Â  deathModal.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  players.me.pollen = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function respawnPlayer() {
Â  Â  Â  Â  Â  Â  players.me.x = 1100; players.me.y = 1100;
Â  Â  Â  Â  Â  Â  players.me.hp = 100; players.me.isDead = false;
Â  Â  Â  Â  Â  Â  deathModal.style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function fire(angle) {
Â  Â  Â  Â  Â  Â  if(Date.now() - lastShootTime < 180 || players.me.isDead) return;
Â  Â  Â  Â  Â  Â  const deg = angle * (180 / Math.PI);
Â  Â  Â  Â  Â  Â  if (deg >= -45 && deg <= 45) players.me.dir = 'Right';
Â  Â  Â  Â  Â  Â  else if (deg > 45 && deg <= 135) players.me.dir = 'Down';
Â  Â  Â  Â  Â  Â  else if (deg < -45 && deg >= -135) players.me.dir = 'Up';
Â  Â  Â  Â  Â  Â  else players.me.dir = 'Left';

Â  Â  Â  Â  Â  Â  spawnProjectile(players.me.x, players.me.y, angle, true);
Â  Â  Â  Â  Â  Â  if(conn && conn.open) conn.send({ type: 'shoot', x: players.me.x, y: players.me.y, angle: angle });
Â  Â  Â  Â  Â  Â  lastShootTime = Date.now();
Â  Â  Â  Â  }

Â  Â  Â  Â  function spawnProjectile(x, y, angle, isMe) {
Â  Â  Â  Â  Â  Â  projectiles.push({ x, y, vx: Math.cos(angle)*12, vy: Math.sin(angle)*12, life: 60, color: isMe ? players.me.color : players.peer.color, owner: isMe ? 'me' : 'peer' });
Â  Â  Â  Â  }

Â  Â  Â  Â  function runWaveLogic() {
Â  Â  Â  Â  Â  Â  if (!isHost) return;Â 
Â  Â  Â  Â  Â  Â  waveTimer -= 1/60;
Â  Â  Â  Â  Â  Â  if (waveTimer <= 0 && !isWaveActive) { isWaveActive = true; enemiesSpawnedInWave = 0; waveTimer = 180; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isWaveActive) {
Â  Â  Â  Â  Â  Â  Â  Â  let now = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  if (enemiesSpawnedInWave < 20 && now - lastEnemySpawnTime > 2000) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const angle = Math.random() * Math.PI * 2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enemies.push({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Math.random().toString(36).substr(2, 9),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: hive.x + Math.cos(angle) * 1000,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: hive.y + Math.sin(angle) * 1000,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hp: 100Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enemiesSpawnedInWave++; lastEnemySpawnTime = now;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (enemies.length === 0 && enemiesSpawnedInWave >= 20) isWaveActive = false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let syncEvent = null;
Â  Â  Â  Â  Â  Â  enemies.forEach((en, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const angle = Math.atan2(hive.y - en.y, hive.x - en.x);
Â  Â  Â  Â  Â  Â  Â  Â  en.x += Math.cos(angle) * 2.0; en.y += Math.sin(angle) * 2.0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Dano na Hive (LÃ³gica do Host)
Â  Â  Â  Â  Â  Â  Â  Â  if (!hive.destroyed && Math.hypot(en.x - hive.x, en.y - hive.y) < 50) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(performance.now() % 60 < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hive.hp -= 2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  syncEvent = 'hive_hit';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Dano no Player Me (Host)
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.hypot(en.x - players.me.x, en.y - players.me.y) < 30 && performance.now() % 60 < 2) takeDamage(2);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Dano no Peer (Host detecta e avisa)
Â  Â  Â  Â  Â  Â  Â  Â  if (players.peer.active && !players.peer.isDead && Math.hypot(en.x - players.peer.x, en.y - players.peer.y) < 30) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(performance.now() % 60 < 2) conn.send({type: 'hit', target: 'me'});
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (hive.hp <= 0 && !hive.destroyed) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  hive.hp = 0; hive.destroyed = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => gameOverModal.style.display = 'flex', 1500);Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (conn && conn.open && performance.now() - lastNetUpdate > 50) {
Â  Â  Â  Â  Â  Â  Â  Â  conn.send({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'sync_world',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enemies: enemies,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isWaveActive: isWaveActive,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hiveHp: hive.hp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event: syncEvent
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  lastNetUpdate = performance.now();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateMechanics() {
Â  Â  Â  Â  Â  Â  flowers.forEach(f => {
Â  Â  Â  Â  Â  Â  Â  Â  if(f.cooldown > 0) f.cooldown -= 1/60;
Â  Â  Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (Math.random() < 0.04) createParticles(f.x, f.y, "#fffa65", 1, 'pollen');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(Math.hypot(players.me.x - f.x, players.me.y - f.y) < 50 && players.me.pollen < 100) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players.me.pollen += 0.4;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addXp(0.1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(players.me.pollen >= 100) { f.cooldown = f.maxCooldown; players.me.pollen = 100; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if(Math.hypot(players.me.x - hive.x, players.me.y - hive.y) < 60 && !hive.destroyed) {
Â  Â  Â  Â  Â  Â  Â  Â  if(players.me.pollen >= 100 && hive.hp < hive.maxHp) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players.me.pollen = 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isHost) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hive.hp = Math.min(hive.maxHp, hive.hp + 50);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conn.send({ type: 'repair' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addXp(25);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createParticles(hive.x, hive.y, "#ff4d4d", 15, 'heart');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ColisÃ£o ProjÃ©til -> Inimigo (Calculado por quem atirou ou pelo host)
Â  Â  Â  Â  Â  Â  projectiles.forEach((p, pIdx) => {
Â  Â  Â  Â  Â  Â  Â  Â  enemies.forEach((en) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(Math.hypot(p.x - en.x, p.y - en.y) < 35) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isHost) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  en.hp -= 25;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(en.hp <= 0) { if(p.owner === 'me') addXp(15); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if(p.owner === 'me') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conn.send({ type: 'hit', target: 'enemy', enId: en.id });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addXp(15);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectiles.splice(pIdx, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  particles.forEach((p, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  p.x += p.vx; p.y += p.vy; p.life -= p.decay;
Â  Â  Â  Â  Â  Â  Â  Â  if(p.life <= 0) particles.splice(i, 1);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawIndicators() {
Â  Â  Â  Â  Â  Â  if (players.peer.active && !players.peer.isDead) {
Â  Â  Â  Â  Â  Â  Â  Â  const dx = players.peer.x - players.me.x, dy = players.peer.y - players.me.y;
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.hypot(dx, dy) > 150) drawArrow(dx, dy, players.peer.color);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(!hive.destroyed) {
Â  Â  Â  Â  Â  Â  Â  Â  const hdx = hive.x - players.me.x, hdy = hive.y - players.me.y;
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.hypot(hdx, hdy) > 200) drawArrow(hdx, hdy, "#f1c40f", 90);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawArrow(dx, dy, color, radius = 70) {
Â  Â  Â  Â  Â  Â  const angle = Math.atan2(dy, dx);
Â  Â  Â  Â  Â  Â  ctx.save(); ctx.translate(players.me.x, players.me.y); ctx.rotate(angle);
Â  Â  Â  Â  Â  Â  ctx.beginPath(); ctx.moveTo(radius, 0); ctx.lineTo(radius - 15, -8); ctx.lineTo(radius - 15, 8); ctx.closePath();
Â  Â  Â  Â  Â  Â  ctx.fillStyle = color; ctx.fill(); ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  function sendMsg() {
Â  Â  Â  Â  Â  Â  const text = chatInput.value.trim();
Â  Â  Â  Â  Â  Â  if(text && conn && conn.open) {
Â  Â  Â  Â  Â  Â  Â  Â  conn.send({ type: 'chat', msg: text });
Â  Â  Â  Â  Â  Â  Â  Â  addMsg(players.me.nick, text, "me");
Â  Â  Â  Â  Â  Â  Â  Â  chatInput.value = ""; chatInput.blur();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function addMsg(author, text, senderType) {
Â  Â  Â  Â  Â  Â  const d = document.createElement('div');
Â  Â  Â  Â  Â  Â  const color = (senderType === "me") ? players.me.color : ((senderType === "peer") ? players.peer.color : "#aaa");
Â  Â  Â  Â  Â  Â  d.innerHTML = `<span style="color:${color}; font-weight:bold">${author}:</span> ${text}`;
Â  Â  Â  Â  Â  Â  const display = document.getElementById('chat-display');
Â  Â  Â  Â  Â  Â  display.appendChild(d); display.scrollTop = display.scrollHeight;
Â  Â  Â  Â  }

Â  Â  Â  Â  function startGame() {
Â  Â  Â  Â  Â  Â  document.getElementById('menu').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('lvl-hud').style.display = 'block';
Â  Â  Â  Â  Â  Â  chatWrapper.style.display = 'flex';
Â  Â  Â  Â  Â  Â  sessionPanel.style.display = 'block';
Â  Â  Â  Â  Â  Â  canvas.style.display = 'block';
Â  Â  Â  Â  Â  Â  if('ontouchstart' in window || navigator.maxTouchPoints > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  moveBase.style.display = 'block'; aimBase.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  setupMultitouch();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  resize(); requestAnimationFrame(gameLoop);
Â  Â  Â  Â  }

Â  Â  Â  Â  function setupMultitouch() {
Â  Â  Â  Â  Â  Â  const handleStart = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  for(let t of e.changedTouches) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rM = moveBase.getBoundingClientRect(), rA = aimBase.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.clientX > rM.left && t.clientX < rM.right && t.clientY > rM.top && t.clientY < rM.bottom) touchIds.move = t.identifier;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.clientX > rA.left && t.clientX < rA.right && t.clientY > rA.top && t.clientY < rA.bottom) touchIds.aim = t.identifier;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const handleMove = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  for(let t of e.touches) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.identifier === touchIds.move) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = moveBase.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dx = t.clientX - (r.left + 60), dy = t.clientY - (r.top + 60);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const d = Math.min(Math.sqrt(dx*dx + dy*dy), 40), a = Math.atan2(dy, dx);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  moveStick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  joyMove = { dx: Math.cos(a)*(d/40), dy: Math.sin(a)*(d/40) };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.identifier === touchIds.aim) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = aimBase.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dx = t.clientX - (r.left + 60), dy = t.clientY - (r.top + 60);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const d = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  joyAim.angle = Math.atan2(dy, dx); joyAim.active = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aimStick.style.transform = `translate(${Math.cos(joyAim.angle)*d}px, ${Math.sin(joyAim.angle)*d}px)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const handleEnd = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  for(let t of e.changedTouches) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.identifier === touchIds.move) { touchIds.move = null; joyMove = {dx:0, dy:0}; moveStick.style.transform = 'none'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.identifier === touchIds.aim) { touchIds.aim = null; joyAim.active = false; aimStick.style.transform = 'none'; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  window.addEventListener('touchstart', handleStart, {passive: false});
Â  Â  Â  Â  Â  Â  window.addEventListener('touchmove', handleMove, {passive: false});
Â  Â  Â  Â  Â  Â  window.addEventListener('touchend', handleEnd);
Â  Â  Â  Â  }

Â  Â  Â  Â  function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
Â  Â  Â  Â  window.addEventListener('resize', resize);

Â  Â  Â  Â  function update() {
Â  Â  Â  Â  Â  Â  if(!players.me.isDead) {
Â  Â  Â  Â  Â  Â  Â  Â  let dx = joyMove.dx, dy = joyMove.dy;
Â  Â  Â  Â  Â  Â  Â  Â  if (keys['KeyW'] || keys['ArrowUp']) dy = -1; if (keys['KeyS'] || keys['ArrowDown']) dy = 1;
Â  Â  Â  Â  Â  Â  Â  Â  if (keys['KeyA'] || keys['ArrowLeft']) dx = -1; if (keys['KeyD'] || keys['ArrowRight']) dx = 1;
Â  Â  Â  Â  Â  Â  Â  Â  if (dx !== 0 || dy !== 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const m = Math.sqrt(dx*dx + dy*dy);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players.me.x += (dx/m) * 5; players.me.y += (dy/m) * 5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isMouseDown && !joyAim.active) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(Math.abs(dx) > Math.abs(dy)) players.me.dir = dx > 0 ? 'Right' : 'Left';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else players.me.dir = dy > 0 ? 'Down' : 'Up';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if(joyAim.active) fire(joyAim.angle);
Â  Â  Â  Â  Â  Â  Â  Â  else if(isMouseDown) fire(Math.atan2(mousePos.y - canvas.height/2, mousePos.x - canvas.width/2));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  runWaveLogic(); updateMechanics();

Â  Â  Â  Â  Â  Â  if(performance.now() - lastNetUpdate > 30) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(conn && conn.open) conn.send({ ...players.me, type: 'pos' });Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // HUD SESSÃƒO
Â  Â  Â  Â  Â  Â  let playerListHtml = "";
Â  Â  Â  Â  Â  Â  if(players.peer.active) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  players.peer.x += (players.peer.tX - players.peer.x) * 0.15;Â 
Â  Â  Â  Â  Â  Â  Â  Â  players.peer.y += (players.peer.tY - players.peer.y) * 0.15;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const d = Math.floor(Math.hypot(players.peer.x-players.me.x, players.peer.y-players.me.y)/10);
Â  Â  Â  Â  Â  Â  Â  Â  playerListHtml += `<div class="player-item" style="color:${players.peer.color}"><span>â— ${players.peer.nick} (Lvl ${players.peer.lvl})</span><span>${d}m</span></div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(!hive.destroyed) {
Â  Â  Â  Â  Â  Â  Â  Â  const hpP = Math.floor((hive.hp/hive.maxHp)*100);
Â  Â  Â  Â  Â  Â  Â  Â  playerListHtml += `<div class="player-item" style="color:${hpP > 30 ? '#2ecc71':'#e74c3c'}"><span>ğŸ  Base</span><span>${hpP}%</span></div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  playerItemsContainer.innerHTML = playerListHtml;

Â  Â  Â  Â  Â  Â  projectiles.forEach((p, i) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  p.x += p.vx; p.y += p.vy; p.life--;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(p.life <= 0) projectiles.splice(i, 1);Â 
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  camera.x = players.me.x - canvas.width/2; camera.y = players.me.y - canvas.height/2;
Â  Â  Â  Â  Â  Â  pollenHud.style.display = players.me.pollen > 0 ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  pollenVal.innerText = Math.floor(players.me.pollen) + "%";
Â  Â  Â  Â  Â  Â  document.getElementById('coords').innerText = `X: ${Math.floor(players.me.x)} Y: ${Math.floor(players.me.y)}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawHealthBar(x, y, hp, max = 100, w = 50, h = 6, offset = 55) {
Â  Â  Â  Â  Â  Â  ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(x - w/2, y - offset, w, h);
Â  Â  Â  Â  Â  Â  ctx.fillStyle = hp > (max * 0.3) ? "#2ecc71" : "#e74c3c"; ctx.fillRect(x - w/2, y - offset, w * (hp/max), h);
Â  Â  Â  Â  }

Â  Â  Â  Â  function draw() {
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
Â  Â  Â  Â  Â  Â  ctx.save(); ctx.translate(-camera.x, -camera.y);
Â  Â  Â  Â  Â  Â  const sX = Math.floor(camera.x/TILE_SIZE)*TILE_SIZE, sY = Math.floor(camera.y/TILE_SIZE)*TILE_SIZE;
Â  Â  Â  Â  Â  Â  for(let x=sX; x<sX+canvas.width+TILE_SIZE; x+=TILE_SIZE)Â 
Â  Â  Â  Â  Â  Â  Â  Â  for(let y=sY; y<sY+canvas.height+TILE_SIZE; y+=TILE_SIZE)Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(assets.ground.complete) ctx.drawImage(assets.ground, x, y, TILE_SIZE, TILE_SIZE);

Â  Â  Â  Â  Â  Â  flowers.forEach(f => {
Â  Â  Â  Â  Â  Â  Â  Â  const sway = Math.sin(performance.now() * 0.003 + f.phase) * 5;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = "28px Arial"; ctx.textAlign = "center";
Â  Â  Â  Â  Â  Â  Â  Â  ctx.globalAlpha = f.cooldown > 0 ? 0.5 : 1.0;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(f.emoji, f.x + sway, f.y);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  ctx.globalAlpha = 1.0;

Â  Â  Â  Â  Â  Â  if(!hive.destroyed) {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = "60px Arial"; ctx.textAlign = "center"; ctx.fillText("ğŸ ", hive.x, hive.y + 20);
Â  Â  Â  Â  Â  Â  Â  Â  drawHealthBar(hive.x, hive.y, hive.hp, hive.maxHp, 100, 10, 60);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  drawIndicators();
Â  Â  Â  Â  Â  Â  enemies.forEach(en => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.fillText("ğŸœ", en.x, en.y);Â 
Â  Â  Â  Â  Â  Â  Â  Â  drawHealthBar(en.x, en.y, en.hp, 100, 30, 4, 30);Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  projectiles.forEach(p => { ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); });

Â  Â  Â  Â  Â  Â  particles.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.globalAlpha = p.life;
Â  Â  Â  Â  Â  Â  Â  Â  if(p.type === 'heart') { ctx.font = "20px Arial"; ctx.fillText("â¤ï¸", p.x, p.y); }
Â  Â  Â  Â  Â  Â  Â  Â  else { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 3, 3); }
Â  Â  Â  Â  Â  Â  }); ctx.globalAlpha = 1.0;

Â  Â  Â  Â  Â  Â  const drawB = (p, c, a) => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!assets.bee[p.dir].complete || p.isDead) return;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.globalAlpha = a; ctx.drawImage(assets.bee[p.dir], p.x-32, p.y-32, 64, 64);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.globalAlpha = 1; ctx.font = "bold 14px Segoe UI";Â 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = c; ctx.textAlign = "center"; ctx.fillText(`${p.nick} (Lvl ${p.lvl})`, p.x, p.y-40);
Â  Â  Â  Â  Â  Â  Â  Â  drawHealthBar(p.x, p.y, p.hp);
Â  Â  Â  Â  Â  Â  Â  Â  if(p.pollen > 0 && p.pollen < 100) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = "white"; ctx.fillRect(p.x - 15, p.y + 35, 30, 4);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = "#fffa65"; ctx.fillRect(p.x - 15, p.y + 35, 30 * (p.pollen/100), 4);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  drawB(players.me, players.me.color, 1);
Â  Â  Â  Â  Â  Â  if(players.peer.active) drawB(players.peer, players.peer.color, 0.6);
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
Â  Â  </script>
</body>
</html>
