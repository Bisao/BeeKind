<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bee World - Battle Royale Compass</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Arial', sans-serif; color: white; touch-action: none; }
        canvas { background: #222; display: none; }
        
        /* HUD Superior */
        #hud-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center;
            pointer-events: none; z-index: 50; width: 400px;
        }

        /* Bússola Estilo Warzone/PUBG */
        #compass-viewport {
            width: 300px; height: 40px; background: rgba(0,0,0,0.4);
            border-bottom: 2px solid rgba(255,215,0,0.8);
            position: relative; overflow: hidden;
            mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
        }
        #compass-tape {
            position: absolute; height: 100%; display: flex; align-items: flex-end;
            transition: transform 0.05s linear; will-change: transform;
        }
        .compass-mark {
            position: absolute; width: 60px; text-align: center; font-size: 12px;
            font-weight: bold; padding-bottom: 5px; color: #ddd;
        }
        .compass-mark.cardinal { color: #f1c40f; font-size: 16px; }
        
        #compass-center-mark {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 2px; height: 100%; background: #f1c40f; z-index: 5;
        }

        /* Marcador do Amigo na Bússola */
        #friend-marker-compass {
            position: absolute; top: 5px; width: 12px; height: 12px;
            background: #3498db; border-radius: 2px; transform: rotate(45deg);
            border: 1px solid white; z-index: 4; display: none;
        }

        #coordinates {
            margin-top: 5px; font-size: 12px; color: #aaa; font-family: monospace;
            background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px;
        }

        /* Menu e Joystick (mantidos) */
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.9); padding: 30px; border-radius: 15px; width: 280px; z-index: 100; border: 2px solid #f1c40f; }
        input { width: 80%; padding: 12px; margin-bottom: 10px; border-radius: 5px; border: none; text-align: center; }
        button { width: 90%; padding: 12px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        #joy-base { position: absolute; bottom: 40px; right: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; border: 2px solid rgba(255,255,255,0.2); }
        #joy-stick { position: absolute; width: 40px; height: 40px; background: rgba(241, 196, 15, 0.5); border-radius: 50%; top: 30px; left: 30px; }
    </style>
</head>
<body>

    <div id="hud-container">
        <div id="compass-viewport">
            <div id="compass-center-mark"></div>
            <div id="friend-marker-compass"></div>
            <div id="compass-tape" style="left: 150px;">
                </div>
        </div>
        <div id="coordinates">X: 0 | Y: 0</div>
    </div>

    <div id="menu">
        <h1 style="color: #f1c40f; margin: 0 0 20px 0;">BEE P2P</h1>
        <input type="text" id="room-code" placeholder="Código de 6 dígitos" maxlength="6">
        <button onclick="startSession(true)" style="background: #f1c40f;">CRIAR SALA</button>
        <button onclick="startSession(false)" style="background: #3498db; color: white;">ENTRAR NA SALA</button>
    </div>

    <div id="joy-base"><div id="joy-stick"></div></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menu = document.getElementById('menu');
        const joyBase = document.getElementById('joy-base');
        const joyStick = document.getElementById('joy-stick');
        const coordDisplay = document.getElementById('coordinates');
        const compassTape = document.getElementById('compass-tape');
        const friendMarker = document.getElementById('friend-marker-compass');

        const assets = {
            bee: { Down: new Image(), Left: new Image(), Up: new Image(), Right: new Image() },
            ground: new Image(),
            flowers: [new Image(), new Image(), new Image()]
        };

        assets.bee.Down.src = 'BeeDown.png';
        assets.bee.Left.src = 'BeeLeft.png';
        assets.bee.Up.src = 'BeeUp.png';
        assets.bee.Right.src = 'BeeRight.png';
        assets.ground.src = 'Grass.png';
        assets.flowers[0].src = 'GrassFlower1.png';
        assets.flowers[1].src = 'GrassFlower2.png';
        assets.flowers[2].src = 'GrassFlower3.png';

        let peer, conn, isHost = false;
        let players = {
            me: { x: 500, y: 500, dir: 'Down', angle: 180 },
            peer: { x: 500, y: 500, targetX: 500, targetY: 500, dir: 'Down', active: false }
        };
        
        let camera = { x: 0, y: 0 };
        const TILE_SIZE = 64;
        let lastSendTime = 0;

        // --- GERAR MARCAÇÕES DA BÚSSOLA ---
        function createCompass() {
            const points = { 0: 'N', 45: 'NE', 90: 'E', 135: 'SE', 180: 'S', 225: 'SW', 270: 'W', 315: 'NW' };
            for(let i = -180; i <= 540; i += 15) {
                const mark = document.createElement('div');
                mark.className = 'compass-mark';
                const angle = (i + 360) % 360;
                if(points[angle]) {
                    mark.classList.add('cardinal');
                    mark.innerText = points[angle];
                } else {
                    mark.innerText = angle;
                }
                mark.style.left = (i * 2) + 'px'; // 2px por grau
                compassTape.appendChild(mark);
            }
        }
        createCompass();

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function startSession(hostMode) {
            const code = document.getElementById('room-code').value;
            if (code.length < 4) return alert("Código curto!");
            isHost = hostMode;
            peer = hostMode ? new Peer('bee-' + code) : new Peer();
            peer.on('open', () => {
                if (hostMode) startGame();
                else { conn = peer.connect('bee-' + code); setupConnection(); }
            });
            peer.on('connection', c => { conn = c; setupConnection(); });
        }

        function setupConnection() {
            conn.on('open', () => { if (!isHost) startGame(); });
            conn.on('data', data => {
                players.peer.targetX = data.x;
                players.peer.targetY = data.y;
                players.peer.dir = data.dir;
                players.peer.active = true;
            });
        }

        function startGame() {
            menu.style.display = 'none';
            canvas.style.display = 'block';
            if ('ontouchstart' in window) { joyBase.style.display = 'block'; initJoystick(); }
            gameLoop();
        }

        function movePlayer(dx, dy, speed) {
            players.me.x += dx * speed;
            players.me.y += dy * speed;

            // Calcula o ângulo do movimento (0-360)
            let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
            if(angle < 0) angle += 360;
            players.me.angle = angle;

            if (Math.abs(dx) > Math.abs(dy)) {
                players.me.dir = dx > 0 ? 'Right' : 'Left';
            } else {
                players.me.dir = dy > 0 ? 'Down' : 'Up';
            }

            const now = Date.now();
            if (now - lastSendTime > 33) {
                if (conn && conn.open) conn.send(players.me);
                lastSendTime = now;
            }
        }

        window.addEventListener('mousemove', (e) => {
            if (canvas.style.display === 'block' && joyBase.style.display !== 'block') {
                const dx = e.clientX - canvas.width/2;
                const dy = e.clientY - canvas.height/2;
                if (Math.abs(dx) > 10 || Math.abs(dy) > 10) movePlayer(dx, dy, 0.05);
            }
        });

        function updateHUD() {
            coordDisplay.innerText = `X: ${Math.floor(players.me.x)} | Y: ${Math.floor(players.me.y)}`;

            // Desliza a fita da bússola (150px é o centro do viewport de 300px)
            // Multiplicamos por -2 porque cada grau na fita tem 2px de largura
            compassTape.style.transform = `translateX(${150 - (players.me.angle * 2)}px)`;

            // Marcador do Amigo na Bússola
            if(players.peer.active) {
                const dx = players.peer.x - players.me.x;
                const dy = players.peer.y - players.me.y;
                let angleToFriend = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                if(angleToFriend < 0) angleToFriend += 360;

                // Diferença entre meu ângulo e o ângulo do amigo
                let diff = angleToFriend - players.me.angle;
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;

                // Posiciona o marcador (150px é o centro)
                const markerX = 150 + (diff * 2);
                friendMarker.style.display = (markerX > 0 && markerX < 300) ? 'block' : 'none';
                friendMarker.style.left = markerX + 'px';
            }
        }

        function pseudoRandom(x, y) {
            let n = Math.sin(x * 12.9898 + y * 78.233) * 43758.5453;
            return n - Math.floor(n);
        }

        function drawInfiniteGround() {
            const startX = Math.floor(camera.x / TILE_SIZE) - 1;
            const startY = Math.floor(camera.y / TILE_SIZE) - 1;
            const endX = startX + Math.ceil(canvas.width / TILE_SIZE) + 2;
            const endY = startY + Math.ceil(canvas.height / TILE_SIZE) + 2;

            for (let x = startX; x < endX; x++) {
                for (let y = startY; y < endY; y++) {
                    const posX = x * TILE_SIZE;
                    const posY = y * TILE_SIZE;
                    if (assets.ground.complete) ctx.drawImage(assets.ground, posX, posY, TILE_SIZE, TILE_SIZE);
                    const chance = pseudoRandom(x, y);
                    if (chance < 0.15) {
                        const flowerIdx = Math.floor(pseudoRandom(y, x) * 3);
                        const flowerImg = assets.flowers[flowerIdx];
                        if (flowerImg.complete) ctx.drawImage(flowerImg, posX, posY, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
        }

        function gameLoop() {
            if (players.peer.active) {
                players.peer.x += (players.peer.targetX - players.peer.x) * 0.12;
                players.peer.y += (players.peer.targetY - players.peer.y) * 0.12;
            }

            camera.x = players.me.x - canvas.width / 2;
            camera.y = players.me.y - canvas.height / 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-camera.x, -camera.y);
            drawInfiniteGround();

            if (players.peer.active) drawBee(players.peer, true);
            drawBee(players.me, false);
            ctx.restore();
            
            updateHUD();
            requestAnimationFrame(gameLoop);
        }

        function drawBee(p, isPeer) {
            const img = assets.bee[p.dir];
            if (isPeer) ctx.globalAlpha = 0.6;
            if (img.complete) ctx.drawImage(img, p.x - 32, p.y - 32, 64, 64);
            ctx.globalAlpha = 1.0;
        }

        function initJoystick() {
            let active = false;
            joyBase.addEventListener('touchstart', (e) => { active = true; e.preventDefault(); });
            window.addEventListener('touchend', () => { active = false; joyStick.style.transform = `translate(0px, 0px)`; });
            window.addEventListener('touchmove', (e) => {
                if (!active) return;
                const touch = e.touches[0];
                const rect = joyBase.getBoundingClientRect();
                let dx = touch.clientX - (rect.left + 50);
                let dy = touch.clientY - (rect.top + 50);
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > 40) { dx *= 40/dist; dy *= 40/dist; }
                joyStick.style.transform = `translate(${dx}px, ${dy}px)`;
                movePlayer(dx, dy, 0.35);
            }, { passive: false });
        }
    </script>
</body>
</html>
