<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bee P2P Game</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; color: white; touch-action: none; }
        canvas { background: #2c3e50; display: none; }
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: #333; padding: 30px; border-radius: 15px; width: 280px; z-index: 10; }
        input { width: 80%; padding: 12px; margin-bottom: 10px; border-radius: 5px; border: none; text-align: center; }
        button { width: 90%; padding: 12px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        #joystick-container { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; touch-action: none; border: 2px solid rgba(255,255,255,0.2); }
        #joystick-knob { position: absolute; width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; top: 35px; left: 35px; }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="color: #f1c40f;">Bee P2P</h1>
        <input type="text" id="room-code" placeholder="Código de 6 dígitos" maxlength="6">
        <button onclick="startSession(true)" style="background: #f1c40f;">Criar Sessão</button>
        <button onclick="startSession(false)" style="background: #3498db; color: white;">Entrar na Sessão</button>
        <p id="status">Aguardando código...</p>
    </div>

    <div id="joystick-container"><div id="joystick-knob"></div></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menu = document.getElementById('menu');
        const statusMsg = document.getElementById('status');
        const joyContainer = document.getElementById('joystick-container');
        const joyKnob = document.getElementById('joystick-knob');

        const beeImg = new Image();
        beeImg.src = 'Bee.png'; // Procura no mesmo diretório

        let peer, conn, isHost = false;
        let players = {
            me: { x: 100, y: 100, targetX: 100, targetY: 100 },
            peer: { x: -100, y: -100 }
        };

        // Ajustar canvas para o tamanho da tela
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function startSession(hostMode) {
            const code = document.getElementById('room-code').value;
            if (code.length < 4) return alert("Código muito curto!");

            isHost = hostMode;
            peer = hostMode ? new Peer('bee-' + code) : new Peer();

            peer.on('open', () => {
                if (hostMode) {
                    statusMsg.innerText = "Esperando amigo no código: " + code;
                    startGame();
                } else {
                    conn = peer.connect('bee-' + code);
                    setupConnection();
                }
            });

            peer.on('connection', c => { conn = c; setupConnection(); });
            peer.on('error', () => { alert("Erro de conexão!"); location.reload(); });
        }

        function setupConnection() {
            conn.on('open', () => { if (!isHost) startGame(); });
            conn.on('data', data => { players.peer.x = data.x; players.peer.y = data.y; });
        }

        function startGame() {
            menu.style.display = 'none';
            canvas.style.display = 'block';
            if ('ontouchstart' in window) {
                joyContainer.style.display = 'block';
                initJoystick();
            }
            gameLoop();
        }

        // --- Movimento Mouse (PC) ---
        window.addEventListener('mousemove', (e) => {
            if (joyContainer.style.display === 'block') return;
            players.me.x = e.clientX;
            players.me.y = e.clientY;
            sendPos();
        });

        // --- Joystick Virtual (Mobile) ---
        function initJoystick() {
            let active = false;
            const limit = 40;
            const startPos = { x: 0, y: 0 };

            const handleMove = (e) => {
                if (!active) return;
                const touch = e.touches[0];
                let dx = touch.clientX - (joyContainer.offsetLeft + 60);
                let dy = touch.clientY - (joyContainer.offsetTop + 60);
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > limit) {
                    dx *= limit / dist;
                    dy *= limit / dist;
                }

                joyKnob.style.transform = `translate(${dx}px, ${dy}px)`;
                
                // Mover a abelha baseado na inclinação do joystick
                players.me.x += dx * 0.2; 
                players.me.y += dy * 0.2;
                sendPos();
            };

            joyContainer.addEventListener('touchstart', () => active = true);
            window.addEventListener('touchend', () => {
                active = false;
                joyKnob.style.transform = `translate(0px, 0px)`;
            });
            window.addEventListener('touchmove', handleMove);
        }

        function sendPos() {
            if (conn && conn.open) conn.send({ x: players.me.x, y: players.me.y });
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Desenha o outro player
            drawBee(players.peer.x, players.peer.y, 0.7); // Um pouco transparente
            
            // Desenha você
            drawBee(players.me.x, players.me.y, 1);

            requestAnimationFrame(gameLoop);
        }

        function drawBee(x, y, alpha) {
            ctx.globalAlpha = alpha;
            // Centraliza a imagem no ponto X, Y (tamanho 60x60)
            ctx.drawImage(beeImg, x - 30, y - 30, 60, 60);
            ctx.globalAlpha = 1.0;
        }
    </script>
</body>
</html>
