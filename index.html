<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>The Hive Kingdom</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
:root { 
--primary: #f1c40f; 
--primary-dark: #b7950b;
--secondary: #3498db;
--bg-dark: rgba(18, 18, 18, 0.95); 
--text-main: #ffffff; 
--xp-color: #3498db; 
--border: rgba(255, 255, 255, 0.1); 
--glass: rgba(255, 255, 255, 0.05);
--royal-gold: #ffd700;
--royal-bg: #1a1a1a;
}

html, body { 
margin: 0; 
overflow: hidden; 
background: #0f0f0f; 
font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
color: var(--text-main); 
touch-action: none; 
user-select: none; 
-webkit-user-select: none; 
-webkit-touch-callout: none; 
}

canvas { display: none; image-rendering: pixelated; }

/* TELA DE SELE√á√ÉO DE PERSONAGEM */
#char-selection-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, #2c2504 0%, #000000 100%);
    z-index: 3500; display: none; flex-direction: column; align-items: center; justify-content: center;
}

.selection-title { color: var(--royal-gold); font-size: 2rem; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 3px; }

.carousel-container {
    display: flex; align-items: center; justify-content: center; gap: 20px;
    width: 90%; perspective: 1000px;
}

.char-card {
    width: 250px; height: 350px; background: var(--bg-dark); border: 2px solid var(--border);
    border-radius: 15px; padding: 20px; transition: all 0.5s;
    display: flex; flex-direction: column; align-items: center; text-align: center;
}

.char-card.active { border-color: var(--primary); transform: translateZ(50px) scale(1.1); box-shadow: 0 0 30px rgba(241, 196, 15, 0.3); }
.char-card.side { opacity: 0.5; filter: blur(2px); transform: translateZ(-50px) scale(0.9); }

.char-img { font-size: 4rem; margin-bottom: 15px; }
.char-info h3 { color: var(--primary); margin: 10px 0; }
.char-info p { font-size: 0.8rem; color: #ccc; }

.nav-arrow { 
    background: var(--primary); border: none; width: 50px; height: 50px; 
    border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold;
}

#central-hud {
position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
display: flex; flex-direction: column; align-items: center; gap: 8px;
z-index: 100; pointer-events: none;
}

#lvl-hud {
background: var(--bg-dark); padding: 10px 25px; border-radius: 25px;
text-align: center; min-width: 220px; backdrop-filter: blur(10px);
border: 1px solid var(--border); display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

#time-hud {
position: absolute; top: 15px; left: 15px;
background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 15px;
font-size: 12px; font-weight: bold; color: #fff; margin-top: 5px;
border: 1px solid var(--border); backdrop-filter: blur(5px);
display: none; align-items: center; gap: 8px;
z-index: 105;
}

#xp-bar-container { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-top: 6px; overflow: hidden; }
#xp-bar-fill { width: 0%; height: 100%; background: var(--xp-color); transition: width 0.3s; box-shadow: 0 0 8px var(--xp-color); }
#lvl-text { font-weight: bold; color: var(--primary); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
#coords { 
font-family: monospace; color: var(--primary); background: var(--bg-dark); 
padding: 4px 15px; border-radius: 12px; font-size: 12px; 
border: 1px solid var(--border); backdrop-filter: blur(5px);
opacity: 0.9; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

#horde-hud {
font-family: monospace; font-weight: 800; color: #e74c3c;
background: var(--bg-dark); padding: 5px 20px; border-radius: 12px;
font-size: 16px; border: 1px solid rgba(231, 76, 60, 0.3);
backdrop-filter: blur(5px); display: none; margin-top: 5px;
text-transform: uppercase; letter-spacing: 1px;
text-align: center; box-shadow: 0 0 15px rgba(231, 76, 60, 0.2);
}

.warn-pulse { animation: warnPulse 1s infinite alternate; }
@keyframes warnPulse {
from { transform: scale(1); opacity: 0.8; box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
to { transform: scale(1.05); opacity: 1; box-shadow: 0 0 25px rgba(231, 76, 60, 0.6); color: #ff6b6b; }
}

#sidebar-container {
position: absolute; left: 0; top: 100px; z-index: 101;
display: flex; flex-direction: column; pointer-events: none;
}
.side-panel {
position: relative; left: -210px; width: 210px;
transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
pointer-events: auto;
}
.side-panel.active { left: 0px; }
.panel-content { 
background: var(--bg-dark); padding: 15px; border-radius: 0 12px 12px 0; 
border-left: 4px solid var(--primary); font-size: 13px; 
backdrop-filter: blur(10px); border: 1px solid var(--border);
box-shadow: 5px 5px 15px rgba(0,0,0,0.4);
overflow: hidden;
}
.panel-toggle {
position: absolute; right: -45px; top: 0;
width: 45px; height: 45px; background: var(--primary);
border: none; border-radius: 0 8px 8px 0; cursor: pointer;
font-size: 20px; display: flex; align-items: center; justify-content: center;
box-shadow: 2px 0 10px rgba(0,0,0,0.2); color: #111;
}
.panel-title { 
font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid var(--primary); 
padding-bottom: 5px; color: var(--primary); font-size: 11px; letter-spacing: 1px;
text-transform: uppercase;
}
.item-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }

#bottom-menu-container {
position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
display: flex; flex-direction: column; align-items: center; gap: 15px;
z-index: 500;
}
#main-action-menu {
background: var(--bg-dark); border: 1px solid var(--primary);
padding: 15px; border-radius: 15px; display: none;
backdrop-filter: blur(10px); box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
grid-template-columns: repeat(3, 1fr); gap: 10px;
}
.square-btn {
width: 50px; height: 50px; background: rgba(255,255,255,0.1);
border: 1px solid rgba(255,255,255,0.2); border-radius: 10px;
cursor: pointer; display: flex; align-items: center; justify-content: center;
font-size: 24px; transition: all 0.2s;
position: relative;
}
.square-btn:hover { background: var(--primary); transform: scale(1.05); }

.point-notify {
position: absolute; top: -5px; right: -5px;
background: #e74c3c; color: white; border-radius: 50%;
width: 18px; height: 18px; font-size: 10px;
display: none; align-items: center; justify-content: center;
border: 2px solid #111;
}

#btn-open-menu {
width: 60px; height: 60px; background: var(--primary);
border: 4px solid rgba(0,0,0,0.2); border-radius: 50%;
cursor: pointer; font-size: 28px; display: flex; align-items: center;
justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
z-index: 501;
}

#btn-repair-hive {
position: absolute; bottom: 180px; right: 40px;
width: 70px; height: 70px; background: #2ecc71;
border: 4px solid rgba(255,255,255,0.3); border-radius: 50%;
cursor: pointer; font-size: 30px; display: none; align-items: center;
justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
z-index: 600; transition: transform 0.1s;
}
#btn-repair-hive:active { transform: scale(0.9); }

#death-modal, #game-over-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
.modal-title { color: #e74c3c; font-size: 48px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; text-align: center; }

#chat-wrapper { 
position: absolute; bottom: 220px; left: -240px; width: 240px; z-index: 500; 
display: none; flex-direction: column; transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
}
#chat-display { height: 160px; background: var(--bg-dark); border-radius: 0 12px 0 0; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; border: 1px solid var(--border); backdrop-filter: blur(15px); font-size: 13px; }
#chat-input-area { display: flex; background: rgba(30, 30, 30, 0.95); padding: 8px; border-radius: 0 0 12px 0; border: 1px solid var(--border); }
#chat-input { flex: 1; background: transparent; border: none; color: white; padding: 4px; font-size: 14px; outline: none; }

#btn-minimize-chat { 
position: absolute; right: -45px; bottom: 0; 
background: var(--primary); color: #111; 
border: none; border-radius: 0 8px 8px 0; cursor: pointer; 
width: 45px; height: 45px; 
font-size: 20px; font-weight: bold; 
box-shadow: 4px 0 10px rgba(0,0,0,0.3); 
transition: background 0.3s;
}

@keyframes pulse {
0% { transform: scale(1); box-shadow: 4px 0 10px rgba(0,0,0,0.3); }
50% { transform: scale(1.1); box-shadow: 0 0 20px var(--primary); background: #fff176; }
100% { transform: scale(1); box-shadow: 4px 0 10px rgba(0,0,0,0.3); }
}
.unread-pulse { animation: pulse 1.5s infinite ease-in-out !important; z-index: 502; }

#progression-modal {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.9); z-index: 2000;
display: none; flex-direction: column; align-items: center; padding: 20px;
backdrop-filter: blur(10px); overflow-y: auto;
}
.progression-container {
width: 100%; max-width: 800px;
background: var(--bg-dark); border: 2px solid var(--primary);
border-radius: 20px; padding: 20px; box-shadow: 0 0 30px rgba(241, 196, 15, 0.2);
}
.progression-header {
display: flex; justify-content: space-between; align-items: center;
border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px;
}
.points-badge {
background: var(--primary); color: #000; padding: 5px 15px;
border-radius: 20px; font-weight: bold; font-size: 14px;
}
.progression-grid {
display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
}
@media (max-width: 600px) { .progression-grid { grid-template-columns: 1fr; } }

.attr-card, .skill-card {
background: rgba(255,255,255,0.03); border: 1px solid var(--border);
border-radius: 12px; padding: 15px;
}
.attr-row {
display: flex; justify-content: space-between; align-items: center;
margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;
}
.attr-info { display: flex; flex-direction: column; }
.attr-name { font-weight: bold; color: var(--primary); font-size: 14px; }
.attr-val { font-size: 18px; font-family: monospace; }
.btn-plus {
width: 32px; height: 32px; background: var(--primary); border: none;
border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 20px;
}
.btn-plus:disabled { opacity: 0.2; cursor: default; }

.skill-tree {
display: flex; flex-direction: column; gap: 10px;
}
.skill-item {
display: flex; align-items: center; gap: 15px;
padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px;
transition: all 0.2s; border: 1px solid transparent;
}
.skill-item.unlocked { border-color: var(--primary); background: rgba(241, 196, 15, 0.1); }
.skill-icon { font-size: 24px; width: 40px; text-align: center; }
.skill-desc { flex: 1; font-size: 12px; color: #ccc; }
.btn-unlock {
padding: 6px 12px; background: var(--secondary); border: none;
border-radius: 6px; color: white; cursor: pointer; font-size: 11px;
}
.btn-unlock:disabled { background: #555; opacity: 0.5; }

#loading-screen {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: radial-gradient(circle at center, #111 0%, #000 100%);
z-index: 4000;
display: none;
flex-direction: column; align-items: center; justify-content: center;
}

#loading-scene {
width: 80%; max-width: 600px;
height: 100px;
position: relative;
margin-bottom: 20px;
}

#loading-bar-track {
position: absolute; bottom: 0; left: 0;
width: 100%; height: 16px;
background: rgba(255,255,255,0.1);
border: 2px solid var(--primary);
border-radius: 8px;
overflow: hidden;
}

#loading-bar-active-fill {
width: 0%; height: 100%;
background: linear-gradient(90deg, var(--primary), var(--primary-dark));
box-shadow: 0 0 10px var(--primary);
}

#loading-ant {
position: absolute; bottom: 16px;
left: 0; transform: translateX(-50%);
font-size: 30px;
transition: left 0.1s linear;
}

#loading-bee-container {
position: absolute; bottom: 30px;
left: -10%;
width: 50px; height: 50px;
transform: translateX(-50%);
transition: left 0.1s linear, transform 0.3s;
}

#loading-bee-img {
width: 100%; height: 100%;
image-rendering: pixelated;
animation: flightBob 0.5s infinite alternate;
}

@keyframes flightBob { from { transform: translateY(0); } to { transform: translateY(-5px); } }

.muzzle-flash {
position: absolute; right: -10px; top: 25px;
width: 10px; height: 10px;
background: #ffeb3b;
border-radius: 50%;
opacity: 0;
box-shadow: 0 0 10px #ffeb3b;
animation: shootFlash 0.3s infinite;
}

@keyframes shootFlash { 0% { opacity: 0; } 50% { opacity: 1; transform: scale(1.5); } 100% { opacity: 0; } }

#loading-cookie {
position: absolute; bottom: 30px; right: 30px;
font-size: 40px;
animation: spinCookie 2s linear infinite;
}

@keyframes spinCookie { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.explosion-text { font-size: 40px !important; animation: explodeScale 0.5s ease-out forwards; }
@keyframes explodeScale { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.5); } 100% { transform: translateX(-50%) scale(0); opacity: 0; } }

#menu { 
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
display: flex; flex-direction: column; align-items: center; justify-content: center;
background: radial-gradient(circle at center, #2c2504 0%, #000000 100%);
z-index: 3000; padding: 20px; box-sizing: border-box;
overflow: hidden;
}

.hex-bg {
position: absolute; top: 0; left: 0; width: 100%; height: 100%;
background-image: 
radial-gradient(var(--royal-gold) 1px, transparent 1px);
background-size: 40px 40px;
opacity: 0.05;
pointer-events: none;
animation: panBg 60s linear infinite;
}

@keyframes panBg { from { background-position: 0 0; } to { background-position: 40px 40px; } }

.pollen-particle {
position: absolute; background: var(--primary);
border-radius: 50%; opacity: 0.6;
animation: floatUp linear infinite;
}

@keyframes floatUp {
0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
50% { opacity: 0.8; }
100% { transform: translateY(-10vh) scale(1.2); opacity: 0; }
}

.menu-card {
position: relative;
background: rgba(10, 10, 10, 0.9);
border: 2px solid var(--royal-gold);
border-radius: 16px;
padding: 40px 30px;
width: 100%; max-width: 500px;
box-shadow: 0 0 30px rgba(241, 196, 15, 0.15), inset 0 0 50px rgba(0,0,0,0.8);
text-align: center;
backdrop-filter: blur(10px);
z-index: 10;
}

.title-box {
display: flex;
align-items: center;
justify-content: center;
gap: 15px;
margin-bottom: 10px;
padding-bottom: 15px;
border-bottom: 1px solid rgba(241, 196, 15, 0.3);
}

.bee-flank {
width: 50px; height: 50px;
animation: swayBee 2s infinite ease-in-out alternate;
image-rendering: pixelated;
flex-shrink: 0;
}

.bee-left { animation-delay: 0s; }
.bee-right { animation-delay: 1s; }

@keyframes swayBee {
from { transform: translateY(0) rotate(-10deg); }
to { transform: translateY(-8px) rotate(10deg); }
}

.menu-card h1 {
font-family: 'Times New Roman', serif;
font-size: 2.2rem; margin: 0;
color: var(--royal-gold);
text-shadow: 0 2px 10px rgba(241, 196, 15, 0.4);
text-transform: uppercase;
letter-spacing: 2px;
white-space: nowrap;
}

.crown-g {
position: relative;
display: inline-block;
}

.crown-g::before {
content: 'üëë';
position: absolute;
top: -28px;
right: -20px;
font-size: 2rem;
transform: rotate(25deg);
filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8));
pointer-events: none;
}

.update-badge {
display: inline-block;
background: linear-gradient(45deg, #b7950b, #f1c40f);
color: #000;
padding: 6px 14px;
border-radius: 20px;
font-size: 0.8rem;
font-weight: bold;
text-transform: uppercase;
margin-bottom: 25px;
box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
animation: glowBadge 2s infinite alternate;
}

@keyframes glowBadge { from { box-shadow: 0 0 5px var(--primary); } to { box-shadow: 0 0 15px var(--primary); } }

.menu-input {
width: 100%; padding: 15px;
background: rgba(0, 0, 0, 0.6);
border: 1px solid #444;
border-left: 3px solid var(--primary-dark);
border-radius: 4px;
color: #e0e0e0; font-size: 1rem;
margin-bottom: 5px;
box-sizing: border-box;
transition: all 0.3s;
font-family: monospace;
user-select: text;
-webkit-user-select: text;
}

.menu-input:focus {
outline: none;
border-color: var(--royal-gold);
background: rgba(20, 20, 20, 0.9);
box-shadow: 0 0 15px rgba(241, 196, 15, 0.1);
}

.input-group label {
display: block; text-align: left;
color: #aaa; font-size: 0.75rem;
text-transform: uppercase;
margin-bottom: 6px; margin-top: 15px;
letter-spacing: 1px;
}

.button-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }

.main-btn {
padding: 16px; cursor: pointer; border-radius: 6px; border: none;
font-weight: 800; font-size: 0.95rem; text-transform: uppercase;
letter-spacing: 1px; transition: all 0.2s;
display: flex; align-items: center; justify-content: center; gap: 8px;
font-family: 'Segoe UI', sans-serif;
position: relative; overflow: hidden;
}

.main-btn::after {
content: ''; position: absolute; top: -50%; left: -50%;
width: 200%; height: 200%;
background: linear-gradient(to bottom right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%);
transform: rotate(45deg) translateY(-100%);
transition: transform 0.5s;
}
.main-btn:hover::after { transform: rotate(45deg) translateY(0%); }

.btn-create { 
background: linear-gradient(to bottom, #f1c40f, #d4ac0d); 
color: #121212; border: 1px solid #f39c12;
}
.btn-join { 
background: linear-gradient(to bottom, #3498db, #2980b9); 
color: white; border: 1px solid #2980b9;
}

#studio-footer { 
position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
text-align: center; pointer-events: none; z-index: 10;
opacity: 0.7; font-size: 0.8rem;
white-space: nowrap;
}

.joy-container { position: absolute; bottom: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; border: 2px solid rgba(255,255,255,0.2); z-index: 150; }
#move-base { left: 40px; }
#aim-base { right: 40px; border-color: rgba(255, 71, 87, 0.3); }
.joy-stick { position: absolute; width: 50px; height: 50px; border-radius: 50%; top: 35px; left: 35px; pointer-events: none; opacity: 0.8; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
</style>
</head>
<body>

<div id="char-selection-screen">
    <div class="hex-bg"></div>
    <h2 class="selection-title">Caste da Colmeia</h2>
    <div class="carousel-container">
        <button class="nav-arrow" onclick="rotateSelection(-1)">‚ùÆ</button>
        <div id="class-cards-wrapper" style="display:flex; gap:20px;">
            </div>
        <button class="nav-arrow" onclick="rotateSelection(1)">‚ùØ</button>
    </div>
    <button class="main-btn btn-create" onclick="confirmClassSelection()" style="width: 250px; margin-top: 40px;">Iniciar Aventura</button>
</div>

<div id="central-hud">
<div id="lvl-hud">
<div id="lvl-text">N√≠vel 1</div>
<div id="xp-bar-container"><div id="xp-bar-fill"></div></div>
</div>
<div id="coords">X: 1100 Y: 1100</div>
<div id="horde-hud"></div>
</div>

<div id="time-hud">‚òÄÔ∏è Dia 1 ‚Ä¢ 08:00</div>

<div id="sidebar-container">
<div id="session-panel" class="side-panel">
<button id="btn-session-toggle" class="panel-toggle">üë•</button>
<div class="panel-content">
<div class="panel-title">Sess√£o Ativa</div>
<div id="player-items-container"></div>
</div>
</div>

<div id="hive-panel" class="side-panel">
<button id="btn-hive-toggle" class="panel-toggle">üè†</button>
<div class="panel-content">
<div class="panel-title">Colmeias Ativas</div>
<div id="hive-items-container"></div>
</div>
</div>
</div>

<div id="bottom-menu-container">
<div id="main-action-menu">
<button class="square-btn" id="btn-progression" title="Evolu√ß√£o">
 üêù <div class="point-notify" id="attr-notify">!</div>
</button>
<button class="square-btn" id="btn-manual-save" title="Salvar Reino">üíæ</button>
<button class="square-btn" style="opacity: 0.3;">üéí</button>
</div>
<button id="btn-open-menu">‚ò∞</button>
</div>

<div id="progression-modal">
<div class="progression-container">
<div class="progression-header">
<h2 style="margin:0; color:var(--primary)">EVOLU√á√ÉO REAL</h2>
<div class="points-badge">Pontos: <span id="stat-points">0</span></div>
<button class="main-btn btn-join" onclick="toggleProgression()" style="padding: 10px 20px; font-size: 12px;">FECHAR</button>
</div>

<div class="progression-grid">
<div class="attr-card">
<h3 style="margin-top:0">Atributos B√°sicos</h3>
<div class="attr-row">
<div class="attr-info">
<span class="attr-name">üí™ FOR√áA</span>
<small>Dano de ataque</small>
</div>
<div style="display:flex; align-items:center; gap:10px">
<span class="attr-val" id="val-str">0</span>
<button class="btn-plus" onclick="upgradeStat('str')">+</button>
</div>
</div>
<div class="attr-row">
<div class="attr-info">
<span class="attr-name">‚ö° AGILIDADE</span>
<small>Velocidade de movimento</small>
</div>
<div style="display:flex; align-items:center; gap:10px">
<span class="attr-val" id="val-agi">0</span>
<button class="btn-plus" onclick="upgradeStat('agi')">+</button>
</div>
</div>
<div class="attr-row">
<div class="attr-info">
<span class="attr-name">‚ù§Ô∏è VITALIDADE</span>
<small>Vida m√°xima (+HP)</small>
</div>
<div style="display:flex; align-items:center; gap:10px">
<span class="attr-val" id="val-vit">0</span>
<button class="btn-plus" onclick="upgradeStat('vit')">+</button>
</div>
</div>
</div>

<div class="skill-card">
<h3 style="margin-top:0">√Årvore Real</h3>
<div class="skill-tree">
<div class="skill-item" id="skill-double">
<div class="skill-icon">üèπ</div>
<div class="skill-desc">
<strong>Disparo Duplo</strong><br>Chance de atirar 2 proj√©teis.
</div>
<button class="btn-unlock" onclick="unlockSkill('double')">2 pts</button>
</div>
<div class="skill-item" id="skill-regen">
<div class="skill-icon">üåø</div>
<div class="skill-desc">
<strong>Regenera√ß√£o</strong><br>Recupera HP lentamente.
</div>
<button class="btn-unlock" onclick="unlockSkill('regen')">3 pts</button>
</div>
<div class="skill-item" id="skill-pollen">
<div class="skill-icon">‚ú®</div>
<div class="skill-desc">
<strong>P√≥len Magn√©tico</strong><br>Coleta p√≥len mais r√°pido.
</div>
<button class="btn-unlock" onclick="unlockSkill('pollen')">2 pts</button>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="death-modal">
<h2 class="modal-title">Derrotado</h2>
<button class="main-btn btn-create" onclick="respawnPlayer()" style="width: 200px;">RESPAWN</button>
</div>
<div id="game-over-modal">
<h2 class="modal-title">COLMEIA DESTRU√çDA</h2>
<button class="main-btn btn-create" onclick="location.reload()" style="width: 200px;">RECOME√áAR</button>
</div>

<div id="chat-wrapper">
<button id="btn-minimize-chat">üí¨</button>
<div id="chat-display"></div>
<div id="chat-input-area">
<input type="text" id="chat-input" placeholder="Falar..." autocomplete="off">
</div>
</div>

<div id="loading-screen">
<div id="loading-scene">
<div id="loading-bee-container">
<div class="muzzle-flash"></div>
<img src="BeeRightIdle.png" id="loading-bee-img">
</div>
<div id="loading-ant">üêú</div>
<div id="loading-bar-track">
<div id="loading-bar-active-fill"></div>
</div>
</div>
<h3 style="color:var(--primary); letter-spacing: 2px; text-transform: uppercase;">Carregando Mundo...</h3>
<div id="loading-cookie">üç™</div>
</div>

<div id="menu">
<div class="hex-bg"></div>
<div class="menu-card">
<div class="title-box">
<img src="BeeLeftIdle.png" class="bee-flank bee-left">
<h1>The Hive Kin<span class="crown-g">g</span>dom</h1>
<img src="BeeRightIdle.png" class="bee-flank bee-right">
</div>
<div class="update-badge">Update: Pollen War ‚Ä¢ v1.4</div>
<div class="input-group">
<label>Identidade do Guerreiro</label>
<input type="text" id="player-nick" class="menu-input" placeholder="Seu apelido..." maxlength="12">
</div>
<div class="input-group">
<label>Nome do Reino (ID da Sala)</label>
<input type="text" id="room-code" class="menu-input" placeholder="Ex: KING1" maxlength="12">
</div>
<div class="input-group">
<label>Chave do Reino (Senha)</label>
<input type="password" id="room-pass" class="menu-input" placeholder="Senha secreta..." maxlength="10">
</div>
<div class="button-row">
<button class="main-btn btn-create" onclick="preStartSession(true)">
<span>üëë</span> Criar Reino
</button>
<button class="main-btn btn-join" onclick="preStartSession(false)">
<span>‚öîÔ∏è</span> Entrar
</button>
</div>
<div style="margin-top: 20px; font-size: 0.8rem; color: #666; font-style: italic;">
"Proteja a Rainha. Colete o Ouro. Sobreviva."
</div>
</div>
<div id="studio-footer">FUNüç™COOK STUDIO &copy; 2025</div>
</div>

<button id="btn-repair-hive">üõ†Ô∏è</button>

<div id="move-base" class="joy-container"><div id="move-stick" class="joy-stick" style="background:var(--primary)"></div></div>
<div id="aim-base" class="joy-container"><div id="aim-stick" class="joy-stick" style="background:#ff4757"></div></div>

<canvas id="gameCanvas"></canvas>

<script>
// VARIAVEIS DE CLASSES
const classes = [
    { name: 'Guerreiro', icon: '‚öîÔ∏è', desc: 'Ataque corpo a corpo pesado com rastro de l√¢mina.', stats: { str: 5, agi: 2, vit: 5 } },
    { name: 'Arqueiro', icon: 'üèπ', desc: 'Dispara flechas r√°pidas e precisas √† dist√¢ncia.', stats: { str: 2, agi: 5, vit: 3 } },
    { name: 'Mago', icon: 'üî•', desc: 'Lan√ßa esferas de fogo que explodem em brasas.', stats: { str: 4, agi: 3, vit: 3 } }
];
let currentClassIdx = 1;
let selectedHostMode = true;

function rotateSelection(dir) {
    currentClassIdx = (currentClassIdx + dir + classes.length) % classes.length;
    renderClassCards();
}

function renderClassCards() {
    const wrapper = document.getElementById('class-cards-wrapper');
    wrapper.innerHTML = '';
    classes.forEach((c, idx) => {
        const card = document.createElement('div');
        card.className = `char-card ${idx === currentClassIdx ? 'active' : 'side'}`;
        card.innerHTML = `
            <div class="char-img">${c.icon}</div>
            <div class="char-info">
                <h3>${c.name}</h3>
                <p>${c.desc}</p>
                <div style="margin-top:10px; font-size:0.7rem; color:var(--primary)">
                    STR: ${c.stats.str} | AGI: ${c.stats.agi} | VIT: ${c.stats.vit}
                </div>
            </div>
        `;
        wrapper.appendChild(card);
    });
}

function preStartSession(host) {
    const nick = document.getElementById('player-nick').value.trim();
    if(!nick) return alert("Escolha um nick!");
    selectedHostMode = host;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('char-selection-screen').style.display = 'flex';
    renderClassCards();
}

function confirmClassSelection() {
    const c = classes[currentClassIdx];
    players.me.class = c.name;
    players.me.stats = {...c.stats};
    players.me.maxHp = 100 + (c.stats.vit * 20);
    players.me.hp = players.me.maxHp;
    document.getElementById('char-selection-screen').style.display = 'none';
    startSession(selectedHostMode);
}

document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
document.addEventListener('gesturechange', function(e) { e.preventDefault(); }); 
document.addEventListener('gestureend', function(e) { e.preventDefault(); });

function createMenuParticles() {
const menu = document.getElementById('menu');
for(let i=0; i<30; i++) {
const p = document.createElement('div');
p.classList.add('pollen-particle');
p.style.left = Math.random() * 100 + '%';
p.style.width = (Math.random() * 4 + 2) + 'px';
p.style.height = p.style.width;
p.style.animationDuration = (Math.random() * 5 + 5) + 's';
p.style.animationDelay = (Math.random() * 5) + 's';
menu.appendChild(p);
}
}
createMenuParticles();

window.onload = function() {
if(localStorage.getItem('hive_nick')) document.getElementById('player-nick').value = localStorage.getItem('hive_nick');
if(localStorage.getItem('hive_room')) document.getElementById('room-code').value = localStorage.getItem('hive_room');
if(localStorage.getItem('hive_pass')) document.getElementById('room-pass').value = localStorage.getItem('hive_pass');
};

function startGame() {
    canvas.style.display = "block";
    document.getElementById('lvl-hud').style.display = "block";
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    gameLoop();
}

function startLoadingSequence() {
document.getElementById('menu').style.display = 'none';
const loadingScreen = document.getElementById('loading-screen');
loadingScreen.style.display = 'flex';

const bar = document.getElementById('loading-bar-active-fill');
const ant = document.getElementById('loading-ant');
const beeCont = document.getElementById('loading-bee-container');
const beeImg = document.getElementById('loading-bee-img');
const muzzle = document.querySelector('.muzzle-flash');

const duration = 5000; 
const startTime = Date.now();
let exploded = false;

function frame() {
const now = Date.now();
const elapsed = now - startTime;
let pct = Math.min(1, elapsed / duration);
const pctVal = pct * 100;

if (pct < 1) {
bar.style.width = pctVal + '%';
ant.style.left = pctVal + '%';
let beePos = Math.max(0, pctVal - 1); 
beeCont.style.left = beePos + '%';
requestAnimationFrame(frame);
} else {
if(!exploded) {
exploded = true;
bar.style.width = '100%';
ant.innerText = "üí•";
ant.classList.add('explosion-text');
muzzle.style.display = 'none';
beeImg.src = 'BeeDownIdle.png';
beeImg.style.animation = 'none'; 
beeCont.style.transition = 'left 0.5s ease-out';
beeCont.style.left = '50%';

setTimeout(() => {
loadingScreen.style.display = 'none';
if(isHost) { 
const hasSave = loadGameProgress(); 
if(!hasSave) generateFlowers(currentRoomCode); 
startGame(); 
} else { 
startGame(); 
}
}, 1000);
}
}
}
requestAnimationFrame(frame);
}

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const chatInput = document.getElementById('chat-input');
const chatWrapper = document.getElementById('chat-wrapper');
const chatMinimizeBtn = document.getElementById('btn-minimize-chat');
const sessionPanel = document.getElementById('session-panel');
const hivePanel = document.getElementById('hive-panel');
const deathModal = document.getElementById('death-modal');
const gameOverModal = document.getElementById('game-over-modal');
const moveBase = document.getElementById('move-base');
const aimBase = document.getElementById('aim-base');
const moveStick = document.getElementById('move-stick');
const aimStick = document.getElementById('aim-stick');
const playerItemsContainer = document.getElementById('player-items-container');
const hiveItemsContainer = document.getElementById('hive-items-container');
const btnOpenMenu = document.getElementById('btn-open-menu');
const mainActionMenu = document.getElementById('main-action-menu');
const btnRepairHive = document.getElementById('btn-repair-hive');
const btnManualSave = document.getElementById('btn-manual-save');

const assets = { 
bee: { 
Down: new Image(), Left: new Image(), Up: new Image(), Right: new Image(),
DownIdle: new Image(), LeftIdle: new Image(), UpIdle: new Image(), RightIdle: new Image()
}, 
ground: new Image() 
};
assets.bee.Down.src = 'BeeDown.png'; 
assets.bee.Left.src = 'BeeLeft.png'; 
assets.bee.Up.src = 'BeeUp.png'; 
assets.bee.Right.src = 'BeeRight.png';
assets.bee.DownIdle.src = 'BeeDownIdle.png'; 
assets.bee.LeftIdle.src = 'BeeLeftIdle.png'; 
assets.bee.UpIdle.src = 'BeeUpIdle.png'; 
assets.bee.RightIdle.src = 'BeeRightIdle.png';
assets.ground.src = 'Grass.png';

let isHost = false;
let hostPassword = ""; 
let hive = { x: 1000, y: 1000, hp: 500, maxHp: 500, destroyed: false };
let currentRoomCode = "";
let lastAutoSaveTime = Date.now();

let dayCycle = {
time: 480, 
day: 1,
speed: 1.5, 
isNight: false,
overlayAlpha: 0
};

let players = { 
me: { 
x: 1100, y: 1100, dir: 'Down', nick: "", color: "#f1c40f", 
hp: 100, maxHp: 100, isDead: false, pollen: 0, 
lvl: 1, xp: 0, nextXp: 100, isCollecting: false,
moving: false, 
statPoints: 0,
stats: { str: 0, agi: 0, vit: 0 },
skills: { double: false, regen: false, pollen: false },
aimAngle: 0,
class: 'Guerreiro'
}, 
peer: { 
x: 1100, y: 1100, tX: 1100, tY: 1100, dir: 'Down', nick: "Amigo", color: "#3498db", 
active: false, hp: 100, maxHp: 100, isDead: false, pollen: 0, lvl: 1, lastSeen: 0, 
isCollecting: false, moving: false, authorized: false, class: 'Guerreiro' 
} 
};

let projectiles = [], enemies = [], flowers = [], particles = []; 
let camera = { x: 0, y: 0 }, peer, conn, keys = {};
const TILE_SIZE = 64;
let lastNetUpdate = 0, lastShootTime = 0, lastEnemySpawnTime = 0, lastHeartbeat = 0;
let mousePos = { x: 0, y: 0 }, isMouseDown = false;
let touchIds = { move: null, aim: null }, joyMove = { dx: 0, dy: 0 }, joyAim = { angle: 0, active: false };

let isWaveActive = false;
let enemiesSpawnedInWave = 0;
let enemiesKilledInWave = 0;
let wavePrepTimer = 0; 
let isWavePrepActive = false;

function seededRandom(seed) {
let value = seed;
return function() {
value = (value * 16807) % 2147483647;
return (value - 1) / 2147483646;
};
}

function stringToSeed(str) {
let hash = 0;
for (let i = 0; i < str.length; i++) hash = ((hash << 5) - hash) + str.charCodeAt(i) | 0;
return Math.abs(hash);
}

function saveGameProgress(isManual = false) {
if (!isHost) return;
const saveData = {
seed: currentRoomCode,
hive: hive,
dayCycle: { time: dayCycle.time, day: dayCycle.day },
flowers: flowers.map(f => ({ id: f.id, cooldown: f.cooldown, growState: f.growState, plantTime: f.plantTime })),
wave: { isActive: isWaveActive, enemiesSpawned: enemiesSpawnedInWave, enemiesKilled: enemiesKilledInWave, prepTimer: wavePrepTimer, isPrepActive: isWavePrepActive },
hostPlayer: { lvl: players.me.lvl, xp: players.me.xp, statPoints: players.me.statPoints, stats: players.me.stats, skills: players.me.skills, x: players.me.x, y: players.me.y, pollen: players.me.pollen, class: players.me.class },
peerPlayer: players.peer.active ? { nick: players.peer.nick, lvl: players.peer.lvl, pollen: players.peer.pollen, hp: players.peer.hp, class: players.peer.class } : (localStorage.getItem(`hive_save_peer_${currentRoomCode}`) ? JSON.parse(localStorage.getItem(`hive_save_peer_${currentRoomCode}`)) : null),
timestamp: Date.now()
};
localStorage.setItem(`hive_save_world_${currentRoomCode}`, JSON.stringify(saveData));
if (isManual) { addMsg("SISTEMA", "Reino salvo!", "msg-sys"); createParticles(players.me.x, players.me.y, "#2ecc71", 15); }
}

function loadGameProgress() {
const rawSave = localStorage.getItem(`hive_save_world_${currentRoomCode}`);
if (!rawSave) return false;
try {
const save = JSON.parse(rawSave);
hive = save.hive;
if(save.dayCycle) { dayCycle.time = save.dayCycle.time; dayCycle.day = save.dayCycle.day; }
generateFlowers(save.seed || currentRoomCode);
players.me.lvl = save.hostPlayer.lvl;
players.me.xp = save.hostPlayer.xp;
players.me.stats = save.hostPlayer.stats;
players.me.class = save.hostPlayer.class || 'Guerreiro';
updateXpHud(); updateProgressionUI();
return true;
} catch (e) { return false; }
}

function generateFlowers(seedStr) {
flowers = [];
const seed = stringToSeed(seedStr);
const rng = seededRandom(seed);
const types = ["üå∏", "üåª", "üå∑"];
const gridSize = 400; const range = 2400;   
for(let gx = -range; gx < range; gx += gridSize) {
for(let gy = -range; gy < range; gy += gridSize) {
if(rng() > 0.4) {
const fx = gx + (rng() * gridSize); const fy = gy + (rng() * gridSize);
if(Math.hypot(fx - hive.x, fy - hive.y) < 200) continue;
flowers.push({ id: flowers.length, x: fx, y: fy, emoji: types[Math.floor(rng() * types.length)], cooldown: 0, maxCooldown: 300, phase: rng() * Math.PI * 2, growState: 'mature', plantTime: 0 });
}
}
}
}

btnManualSave.onclick = () => saveGameProgress(true);
btnOpenMenu.onclick = () => {
const isVisible = mainActionMenu.style.display === 'grid';
mainActionMenu.style.display = isVisible ? 'none' : 'grid';
btnOpenMenu.innerHTML = isVisible ? '‚ò∞' : '‚úï';
};

function toggleProgression() {
const modal = document.getElementById('progression-modal');
const isVisible = modal.style.display === 'flex';
modal.style.display = isVisible ? 'none' : 'flex';
if(!isVisible) updateProgressionUI();
}
document.getElementById('btn-progression').onclick = toggleProgression;

function updateProgressionUI() {
document.getElementById('stat-points').innerText = players.me.statPoints;
document.getElementById('val-str').innerText = players.me.stats.str;
document.getElementById('val-agi').innerText = players.me.stats.agi;
document.getElementById('val-vit').innerText = players.me.stats.vit;
document.getElementById('attr-notify').style.display = players.me.statPoints > 0 ? 'flex' : 'none';
const btns = document.querySelectorAll('.btn-plus');
btns.forEach(b => b.disabled = players.me.statPoints <= 0);
}

function upgradeStat(type) {
if(players.me.statPoints > 0) {
players.me.stats[type]++; players.me.statPoints--;
if(type === 'vit') { players.me.maxHp = 100 + (players.me.stats.vit * 20); players.me.hp += 20; }
updateProgressionUI(); saveGameProgress(); 
}
}

function toggleChat() {
let currentLeft = window.getComputedStyle(chatWrapper).getPropertyValue('left');
let isHidden = currentLeft.includes('-') || currentLeft === 'auto';
chatWrapper.style.left = isHidden ? "0px" : "-240px";
chatMinimizeBtn.innerHTML = isHidden ? "¬´" : "üí¨";
}
chatMinimizeBtn.onclick = toggleChat;

function addXp(amount) {
if(players.me.isDead) return;
players.me.xp += amount;
if(players.me.xp >= players.me.nextXp) {
players.me.xp -= players.me.nextXp; players.me.lvl++; players.me.statPoints += 2;
players.me.nextXp = Math.floor(100 * Math.pow(1.2, players.me.lvl));
updateProgressionUI(); updateXpHud();
}
updateXpHud();
}

function updateXpHud() {
const perc = (players.me.xp / players.me.nextXp) * 100;
document.getElementById('xp-bar-fill').style.width = perc + "%";
document.getElementById('lvl-text').innerText = `N√≠vel ${players.me.lvl}`;
}

function createParticles(x, y, color, count, type = 'pixel') {
for(let i=0; i<count; i++) {
let vx = (Math.random() - 0.5) * 4; let vy = (Math.random() - 0.5) * 4;
let life = 1.0; let decay = Math.random() * 0.02 + 0.01;
if(type === 'fire') { vx *= 0.8; vy -= 2; color = `rgb(255, ${Math.random()*150}, 0)`; }
particles.push({ x, y, vx, vy, life, decay, color, type });
}
}

window.addEventListener('mousemove', e => { mousePos.x = e.clientX; mousePos.y = e.clientY; });
window.addEventListener('mousedown', () => { isMouseDown = true; });
window.addEventListener('mouseup', () => { isMouseDown = false; });
window.addEventListener('keydown', e => { if(document.activeElement !== chatInput) keys[e.code] = true; });
window.addEventListener('keyup', e => { keys[e.code] = false; });

function startSession(host) {
const code = document.getElementById('room-code').value.trim();
const nick = document.getElementById('player-nick').value.trim();
const pass = document.getElementById('room-pass').value.trim();
isHost = host; hostPassword = pass; currentRoomCode = code; players.me.nick = nick;
if(peer && !peer.destroyed) peer.destroy();
peer = new Peer(host ? 'hive-game-' + code : null);
peer.on('open', (id) => { if(host) startLoadingSequence(); else { conn = peer.connect('hive-game-' + code); setupConn(); } });
peer.on('connection', c => { conn = c; setupConn(); });
}

function setupConn() {
conn.on('open', () => { if(!isHost) conn.send({ type: 'auth', pass: hostPassword, nick: players.me.nick, class: players.me.class }); });
conn.on('data', data => {
if(data.type === 'auth') {
    if(data.pass === hostPassword) {
        players.peer.nick = data.nick;
        players.peer.class = data.class;
        players.peer.active = true;
        conn.send({ type: 'auth_success', hive: hive, dayCycle: dayCycle, seed: currentRoomCode });
    }
}
else if(data.type === 'auth_success') {
    hive = data.hive;
    dayCycle = data.dayCycle;
    generateFlowers(data.seed);
    startLoadingSequence();
}
else if(data.type === 'pos') { 
    players.peer.tX = data.x; 
    players.peer.tY = data.y; 
    players.peer.active = true; 
    players.peer.class = data.class; 
    players.peer.dir = data.dir; 
    players.peer.moving = data.moving;
}
else if(data.type === 'shoot') spawnProjectile(data.x, data.y, data.angle, false, data.class);
else if(data.type === 'world_sync' && !isHost) {
    hive = data.hive;
    enemies = data.enemies;
}
});
}

function fire(angle) {
if(Date.now() - lastShootTime < (players.me.class === 'Guerreiro' ? 400 : 200) || players.me.isDead) return;
spawnProjectile(players.me.x, players.me.y, angle, true, players.me.class);
if(conn && conn.open) conn.send({ type: 'shoot', x: players.me.x, y: players.me.y, angle: angle, class: players.me.class });
lastShootTime = Date.now();
}

function spawnProjectile(x, y, angle, isMe, pClass) {
    let color = "#fff"; let life = 60; let size = 4;
    if(pClass === 'Mago') color = "#ff4500";
    if(pClass === 'Guerreiro') { size = 20; life = 10; color = "rgba(255,255,255,0.5)"; }
    projectiles.push({ 
        x, y, vx: Math.cos(angle)*12, vy: Math.sin(angle)*12, 
        life, color, owner: isMe ? 'me' : 'peer', class: pClass, size, angle 
    });
}

function takeDamage(amt) {
    if(players.me.isDead) return;
    players.me.hp -= amt;
    if(players.me.hp <= 0) {
        players.me.hp = 0;
        players.me.isDead = true;
        deathModal.style.display = 'flex';
    }
}

function respawnPlayer() {
    players.me.hp = players.me.maxHp;
    players.me.isDead = false;
    players.me.x = hive.x;
    players.me.y = hive.y;
    deathModal.style.display = 'none';
}

function runWaveLogic() {
if (!isHost) return;
const hour = dayCycle.time / 60;
if (dayCycle.day % 3 === 0 && (hour >= 22 || hour < 6)) {
if (!isWaveActive) { isWaveActive = true; enemiesSpawnedInWave = 0; }
if (enemiesSpawnedInWave < 20 && Date.now() - lastEnemySpawnTime > 2000) {
const a = Math.random()*Math.PI*2;
enemies.push({ id: Math.random().toString(36), x: hive.x + Math.cos(a)*800, y: hive.y + Math.sin(a)*800, hp: 100 });
enemiesSpawnedInWave++; lastEnemySpawnTime = Date.now();
}
}
enemies.forEach(en => {
const a = Math.atan2(hive.y - en.y, hive.x - en.x);
en.x += Math.cos(a)*2; en.y += Math.sin(a)*2;
if(Math.hypot(en.x-players.me.x, en.y-players.me.y)<40 && performance.now()%60<2) takeDamage(5);
});

if(conn && conn.open && performance.now() % 500 < 20) {
    conn.send({ type: 'world_sync', hive: hive, enemies: enemies });
}
}

function drawHealthBar(x, y, hp, max) {
    const w = 40; const h = 5;
    ctx.fillStyle = "#000"; ctx.fillRect(x - w/2, y - 50, w, h);
    ctx.fillStyle = "#2ecc71"; ctx.fillRect(x - w/2, y - 50, w * (hp/max), h);
}

function update() {
if(!players.me.isDead) {
const speed = 5 + (players.me.stats.agi * 0.4);
let dx = 0, dy = 0;
if(keys['KeyW']) dy = -1; if(keys['KeyS']) dy = 1; if(keys['KeyA']) dx = -1; if(keys['KeyD']) dx = 1;
if(dx!==0 || dy!==0) {
const m = Math.sqrt(dx*dx + dy*dy);
players.me.x += (dx/m)*speed; players.me.y += (dy/m)*speed;
players.me.moving = true;
if(dx!==0) players.me.dir = dx > 0 ? 'Right' : 'Left';
} else players.me.moving = false;

if(isMouseDown) {
const angle = Math.atan2(mousePos.y - canvas.height/2, mousePos.x - canvas.width/2);
players.me.aimAngle = angle; fire(angle);
}
}

// Interpola√ß√£o do Peer
players.peer.x += (players.peer.tX - players.peer.x) * 0.2;
players.peer.y += (players.peer.tY - players.peer.y) * 0.2;

dayCycle.time += dayCycle.speed / 60;
if(dayCycle.time >= 1440) { dayCycle.time = 0; dayCycle.day++; }
const h = Math.floor(dayCycle.time/60).toString().padStart(2,'0');
const m = Math.floor(dayCycle.time%60).toString().padStart(2,'0');
document.getElementById('time-hud').style.display = 'flex';
document.getElementById('time-hud').innerText = `Dia ${dayCycle.day} ‚Ä¢ ${h}:${m}`;

runWaveLogic();
projectiles.forEach((p, i) => {
    p.x += p.vx; p.y += p.vy; p.life--;
    if(p.class === 'Mago') createParticles(p.x, p.y, "#ff4500", 1, 'fire');
    if(p.life <= 0) projectiles.splice(i, 1);
    enemies.forEach(en => {
        if(Math.hypot(p.x-en.x, p.y-en.y)<40) {
            en.hp -= (p.class === 'Guerreiro' ? 40 : 20);
            createParticles(en.x, en.y, p.color, 5);
            if(p.class !== 'Guerreiro') p.life = 0;
        }
    });
});
enemies = enemies.filter(en => en.hp > 0);
particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life -= p.decay; if(p.life <= 0) particles.splice(i, 1); });

if(conn && conn.open && performance.now() - lastNetUpdate > 50) {
conn.send({ type: 'pos', x: players.me.x, y: players.me.y, class: players.me.class, dir: players.me.dir, moving: players.me.moving });
lastNetUpdate = performance.now();
}
camera.x = players.me.x - canvas.width/2; camera.y = players.me.y - canvas.height/2;

document.getElementById('coords').innerText = `X: ${Math.floor(players.me.x)} Y: ${Math.floor(players.me.y)}`;
}

function draw() {
ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.save(); ctx.translate(-camera.x, -camera.y);
for(let x=Math.floor(camera.x/TILE_SIZE)*TILE_SIZE; x<camera.x+canvas.width+TILE_SIZE; x+=TILE_SIZE)
for(let y=Math.floor(camera.y/TILE_SIZE)*TILE_SIZE; y<camera.y+canvas.height+TILE_SIZE; y+=TILE_SIZE)
if(assets.ground.complete) ctx.drawImage(assets.ground, x, y, TILE_SIZE, TILE_SIZE);

ctx.font = "60px Arial"; ctx.fillText("üè†", hive.x-30, hive.y+20);
enemies.forEach(en => { ctx.font = "30px Arial"; ctx.fillText("üêú", en.x-15, en.y+10); });

projectiles.forEach(p => {
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.angle);
    ctx.fillStyle = p.color;
    if(p.class === 'Arqueiro') ctx.fillRect(-10, -2, 20, 4);
    else if(p.class === 'Guerreiro') {
        ctx.beginPath(); ctx.arc(0, 0, p.size, 0, Math.PI, true); ctx.fill();
    }
    else { ctx.beginPath(); ctx.arc(0, 0, p.size, 0, Math.PI*2); ctx.fill(); }
    ctx.restore();
});

particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4); });
ctx.globalAlpha = 1.0;

const drawPlayer = (p, isMe) => {
    let sprite = p.moving ? assets.bee[p.dir] : assets.bee[p.dir+"Idle"];
    if(sprite && sprite.complete) ctx.drawImage(sprite, p.x-32, p.y-32, 64, 64);
    ctx.fillStyle = isMe ? "#f1c40f" : "#3498db"; ctx.font = "12px Arial";
    ctx.fillText(`${p.nick} [${p.class}]`, p.x-30, p.y-40);
    drawHealthBar(p.x, p.y, p.hp, p.maxHp);
};
drawPlayer(players.me, true);
if(players.peer.active) drawPlayer(players.peer, false);
ctx.restore();
}

function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
</script>
</body>
</html>
