<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bee World - High Performance</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; color: white; touch-action: none; }
        canvas { display: none; image-rendering: pixelated; } /* Otimiza renderização de pixels */
        #hud-container { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); pointer-events: none; z-index: 50; width: 300px; text-align: center; }
        #compass-viewport { width: 300px; height: 35px; background: rgba(0,0,0,0.5); border-bottom: 2px solid #f1c40f; position: relative; overflow: hidden; }
        #compass-tape { position: absolute; height: 100%; display: flex; align-items: flex-end; will-change: transform; }
        .compass-mark { position: absolute; width: 60px; text-align: center; font-size: 12px; font-weight: bold; color: #ddd; }
        #coordinates { margin-top: 5px; font-size: 11px; color: #f1c40f; font-family: monospace; }
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: #222; padding: 30px; border-radius: 15px; border: 2px solid #f1c40f; z-index: 100; }
        input { padding: 10px; width: 80%; border-radius: 5px; border: none; margin-bottom: 10px; }
        button { padding: 10px; width: 85%; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; background: #f1c40f; }
        #joy-base { position: absolute; bottom: 40px; right: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; border: 2px solid rgba(255,255,255,0.2); }
        #joy-stick { position: absolute; width: 40px; height: 40px; background: rgba(241, 196, 15, 0.5); border-radius: 50%; top: 30px; left: 30px; }
    </style>
</head>
<body>

    <div id="hud-container">
        <div id="compass-viewport">
            <div style="position:absolute; top:0; left:50%; width:2px; height:100%; background:#f1c40f; z-index:5;"></div>
            <div id="compass-tape"></div>
        </div>
        <div id="coordinates">X: 0 | Y: 0</div>
    </div>

    <div id="menu">
        <h1 style="color:#f1c40f">BEE P2P</h1>
        <input type="text" id="room-code" placeholder="Código 6 dígitos">
        <button onclick="startSession(true)">CRIAR SALA</button>
        <button onclick="startSession(false)" style="background:#3498db; color:white; margin-top:10px">ENTRAR</button>
    </div>

    <div id="joy-base"><div id="joy-stick"></div></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // Otimização: Desativa transparência do canvas principal
        const compassTape = document.getElementById('compass-tape');
        
        // Cache de Sprites
        const assets = {
            bee: { Down: new Image(), Left: new Image(), Up: new Image(), Right: new Image() },
            ground: new Image(),
            flowers: [new Image(), new Image(), new Image()]
        };
        assets.bee.Down.src = 'BeeDown.png';
        assets.bee.Left.src = 'BeeLeft.png';
        assets.bee.Up.src = 'BeeUp.png';
        assets.bee.Right.src = 'BeeRight.png';
        assets.ground.src = 'Grass.png';
        assets.flowers[0].src = 'GrassFlower1.png';
        assets.flowers[1].src = 'GrassFlower2.png';
        assets.flowers[2].src = 'GrassFlower3.png';

        let peer, conn;
        let players = {
            me: { x: 500, y: 500, dir: 'Down', angle: 0 },
            peer: { x: 500, y: 500, targetX: 500, targetY: 500, dir: 'Down', active: false }
        };
        let camera = { x: 0, y: 0 };
        const keys = {};
        const TILE_SIZE = 64;
        let lastNetUpdate = 0;

        // Bússola Otimizada
        function setupCompass() {
            const pts = { 0:'N', 90:'E', 180:'S', 270:'W' };
            for(let i = -180; i <= 540; i += 45) {
                const d = document.createElement('div');
                d.className = 'compass-mark';
                d.innerText = pts[(i+360)%360] || (i+360)%360;
                d.style.left = (i * 2) + 'px';
                compassTape.appendChild(d);
            }
        }
        setupCompass();

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.imageSmoothingEnabled = false; // Ganho de performance em pixel art
        }
        window.addEventListener('resize', resize);
        resize();

        function startSession(host) {
            const code = document.getElementById('room-code').value;
            peer = host ? new Peer('bee-'+code) : new Peer();
            peer.on('open', () => {
                if(host) startGame();
                else { conn = peer.connect('bee-'+code); setupConn(); }
            });
            peer.on('connection', c => { conn = c; setupConn(); });
        }

        function setupConn() {
            conn.on('open', () => { players.peer.active = true; startGame(); });
            conn.on('data', data => {
                players.peer.targetX = data.x;
                players.peer.targetY = data.y;
                players.peer.dir = data.dir;
                players.peer.active = true;
            });
        }

        function startGame() {
            document.getElementById('menu').style.display = 'none';
            canvas.style.display = 'block';
            if('ontouchstart' in window) document.getElementById('joy-base').style.display = 'block';
            requestAnimationFrame(gameLoop);
        }

        function update() {
            let dx = 0, dy = 0;
            if (keys['KeyW'] || keys['ArrowUp']) dy -= 1;
            if (keys['KeyS'] || keys['ArrowDown']) dy += 1;
            if (keys['KeyA'] || keys['ArrowLeft']) dx -= 1;
            if (keys['KeyD'] || keys['ArrowRight']) dx += 1;

            if (dx !== 0 || dy !== 0) {
                const mag = Math.sqrt(dx*dx + dy*dy);
                players.me.x += (dx/mag) * 5;
                players.me.y += (dy/mag) * 5;
                players.me.angle = (Math.atan2(dy, dx) * 180 / Math.PI + 90 + 360) % 360;
                players.me.dir = Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? 'Right' : 'Left') : (dy > 0 ? 'Down' : 'Up');
                
                const now = performance.now();
                if(now - lastNetUpdate > 30) {
                    if(conn && conn.open) conn.send(players.me);
                    lastNetUpdate = now;
                }
            }

            if(players.peer.active) {
                players.peer.x += (players.peer.targetX - players.peer.x) * 0.15;
                players.peer.y += (players.peer.targetY - players.peer.y) * 0.15;
            }
            
            camera.x = players.me.x - canvas.width/2;
            camera.y = players.me.y - canvas.height/2;
        }

        function draw() {
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-camera.x, -camera.y);

            // Renderização do Chão com Culling (Apenas o que é visível)
            const x1 = Math.floor(camera.x / TILE_SIZE);
            const y1 = Math.floor(camera.y / TILE_SIZE);
            const x2 = x1 + Math.ceil(canvas.width / TILE_SIZE) + 1;
            const y2 = y1 + Math.ceil(canvas.height / TILE_SIZE) + 1;

            for(let x = x1; x < x2; x++) {
                for(let y = y1; y < y2; y++) {
                    const px = x * TILE_SIZE;
                    const py = y * TILE_SIZE;
                    if(assets.ground.complete) ctx.drawImage(assets.ground, px, py, TILE_SIZE, TILE_SIZE);
                    
                    // Flores (pseudo-aleatórias fixas)
                    const seed = (x * 12.9898 + y * 78.233);
                    const rng = Math.abs(Math.sin(seed) * 43758.5453) % 1;
                    if(rng < 0.1) {
                        const f = assets.flowers[Math.floor(rng * 30)];
                        if(f && f.complete) ctx.drawImage(f, px, py, TILE_SIZE, TILE_SIZE);
                    }
                }
            }

            // Desenhar Players
            renderBee(players.me, 1);
            if(players.peer.active) renderBee(players.peer, 0.6);

            ctx.restore();

            // UI
            document.getElementById('coordinates').innerText = `X: ${Math.floor(players.me.x)} Y: ${Math.floor(players.me.y)}`;
            compassTape.style.transform = `translateX(${150 - (players.me.angle * 2)}px)`;
        }

        function renderBee(p, alpha) {
            const img = assets.bee[p.dir];
            if(img.complete) {
                ctx.globalAlpha = alpha;
                ctx.drawImage(img, p.x - 32, p.y - 32, 64, 64);
                ctx.globalAlpha = 1;
            }
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
